{
  "id": 3920,
  "origin_website": "Cell",
  "title": "Protocol for image registration of correlative soft X-ray tomography and super-resolution structured illumination microscopy images",
  "procedures": [
    "Step-by-step method details\nStep-by-step method details\nChromatic shift correction\nTiming: 5 min–15 min\nThe channels in reconstructed SIM data files (SIR) may be misaligned in x, y, and z with respect to each other due to: (a) mechanical misalignment in the optical path and/or (b) chromatic shift between wavelengths. Both can be corrected using the software Chromagnon (Matsuda et al., 2018[href=https://www.wicell.org#bib7]). Here are two methods for SIM channel correction depending on the data:\nMethod 1:\nThis method will only work if there are common fluorescent features in both channels. No reference image is required, only the image to be aligned.\nAdd the SIR data (for 2-channel data files) to both the reference and target fields in Chromagnon. Alternatively, if each fluorescence channel is available in separate files add one as the ‘target’ and one as the ‘source’.\nPress ‘Run all’.\nEvaluate the result visually (automatic display by Chromagnon); fluorescence signal should align well in all dimensions.\nMethod 2:\nThis method uses a reference matrix supplied by the user facility that provides microscope access (it will be specific to the particular optical setup in place at the time of data collection). It can be used when there are no common features in the fluorescence signal in different channels. The reference file is a ‘chromagnon.csv’ file which contains the alignment parameters for the system and has been obtained beforehand from calibration images. It can be used to batch-process multiple images at once.\nObtain the reference files from the microscope facility/beamline support scientists.\nChoose the appropriate reference file which matches the laser wavelength and filter used for imaging your sample and add it to the ‘reference’ field.\nAdd the SIR data to be aligned in the ‘source’ field.",
    "Check the suffix to be used in the target panel and choose .dv as output format. The output will be a <filename>_ALN.dv file.\nPress ‘Run all’.\nEvaluate the result visually; fluorescence signal should align well.\nFor batch-processing place all SIR images to be aligned in the source field, and the reference file in the reference field and press ‘Run all’.\nNote: When using a single 2-channel file as both reference and target data, Chromagnon will automatically define the lower wavelength channel as the source.\nNote: The 3D transformation file <filename>.dms.chromagnon.csv, created automatically by Chromagnon, and the log file .log should be saved as records.\nThe output image of this step is the corrected SIR for chromatic shift and should be created with the name <original_SIR_Filename>_ALN.tif.\nStage shift correction\nTiming: 15 min–30 min\nIn some cases, particularly if there is a time lag between acquisitions of successive datasets, there may also be shifts in the microscope stage that need to be accounted for. For example, this can occur if a sample has multiple emitters at different wavelengths to be recorded (the cryoSIM microscope can only record two channels per acquisition). In that case, data are recorded in sets of two channels and each time at least one wavelength is re-collected to act as a reference point against the added channels collected.\nSee Figure 2[href=https://www.wicell.org#fig2] for a schematic of the processing steps.\nimgsrc:https://prod-shared-star-protocols.s3.amazonaws.com/protocols/643-Fig2.jpg\nFigure 2. Schematic illustrating the steps in image registration for correcting for chromatic and stage shift for representative 4-channel SIR data",
    "Data pairs should be chosen with a view of enabling the calculation of stage drift between successive data acquisition runs. First, the chromatic shift between fluorescence channels is corrected and then the stage-induced drift is calculated from the same channel taken at different time points. The stage drift transformation matrix is then applied to the chromatically corrected channels and finally all channels are merged to obtain a cumulative internally aligned dataset with all the available channels.\nAcquire pairs of images, with one common channel in both pairs:\nDesignate one image from one channel to be the reference to which all other images will be transformed to. Always add this image in the ‘reference’ part of Chromagnon whenever it is used. In Figure 2[href=https://www.wicell.org#fig2] this is the green channel 1, from the first image pair.\nPerform the chromatic shift correction on each channel:\nFollow the same steps as in the Chromatic Shift Correction section of this paper.\nCalculate the stage shift and apply the matrix to correct for stage shift to the other channel(s):\nOpen Icy.\nOpen the datasets of the same channel taken at different times. These will contain the same information but will not be entirely co-incident in 3D due to shifts in the microscope setup that can occur between successive data collection cycles.\nOpen ec-CLEM.\nAssign the images as ‘target’ (the reference image) and ‘source’ (the image that you want to transform).\nFollow steps d-h from the Image Registration section of this paper to co-register the images.\nA transformation schema file will be saved in the source image folder.\nOpen the data corresponding to the second channel from ‘source’ <filename>._SIR_ALN.dv.\nIn ec-CLEM, go to ‘Advanced Usage’→ ‘Apply transformation matrix’.",
    "Choose the channel to transform and the transformation schema file that was just created and click the play button to apply the transform.\nSave the transformed data.\nRepeat the steps if there are other images that require alignment for stage shift.\nMerge all final aligned channels into one image using Icy (Sequence→Merge) or ImageJ/Fiji.\nPre-processing of images for registration\nTiming: 5 min–30 min\nSIR and SXT 3D image stacks are converted to 2D z axis maximum/minimum intensity projections for ease of processing during the first 2D registration step. This can be done in either Icy or Fiji/ImageJ.\nPre-processing in Icy\nOpen Icy and search for one of the relevant plugins: Projection or Intensity Projection.\nChoose to project along the z axis.\nChoose maximum as the projection type for the SIR image stack (Figures 3[href=https://www.wicell.org#fig3]A and 3B).\nimgsrc:https://prod-shared-star-protocols.s3.amazonaws.com/protocols/643-Fig3.jpg\nFigure 3. Slices from data z-stacks compared to their contrast-adjusted 2D maximum/minimum intensity projections\nThe projection images demonstrate the highlighted information for registration.\n(A and B) (A) Slice from an SIR image stack and its total data maximum intensity projection (B).\n(C and D) (C) Slice from a bright-field z-stack taken on the cryoSIM and its total data minimum intensity projection (D).\n(E and F) (E) Slice from an X-ray tomogram and the corresponding minimum intensity projection of all data slices (F). The scale bars are 2 μm.\nChoose minimum as the projection type for the bright-field image stack and the X-ray tomogram stacks (Figures 3[href=https://www.wicell.org#fig3]C–3F).\nManually adjust the contrast using the minimum and maximum sliders on the histogram in the bar on the right in Icy to obtain the best contrast for viewing features in the image.\nSave these projection images to use in the next steps.\nPre-processing in Fiji\nOpen Fiji and go to Image→ Stacks → Z Project:",
    "For the SIR stack, choose ‘maximum intensity’ for the projection type (Figures 3[href=https://www.wicell.org#fig3]A and 3B).\nFor the bright-field image stack and the X-ray tomogram stacks, choose ‘minimum intensity’ for the projection type (Figures 3[href=https://www.wicell.org#fig3]C–3F).\nManually adjust the contrast if needed by going to Image→Adjust→Brightness/Contrast.\nName and save these projection images, which will be used in subsequent registration steps.\nNote: Before applying the projections, it may help to remove out-of-focus slices from the start and/or end of a stack (for example caused by the sample being tilted in the z direction), to obtain a clearer final projection image (use Image → Stacks→Tools→Make Substack)\nNote: It is possible to reduce the file size of the reconstructed X-ray tomogram stacks in the same way by deleting slices which do not contain any features (commonly at the beginning and end of the stack).\nImage registration\nTiming: 30 min–1 day depending on data size\nThere are three main steps in Correlative Light X-ray Tomography (CLXT) data registration. First, three separate 2D registrations are done. Then a new transformation schema is created and applied to the 3D image stacks. Finally, the 3D stacks are registered in z.\nNote: Steps one and two can be done on any standard computer but the 3D registration in step 3 is more computationally intensive and requires a system with enhanced RAM capacities (at least 16 Gb).\nNote: Any files generated by ec-CLEM will be saved in the same folder as the input source image.\nCompute the 2D image registrations:\nEnsure the following images are saved in the same directory:\n2D SIR (image obtained from Z-projection of maximum intensity, fluorescence microscopy).\n2D brightfield (image, minimum intensity z-projection).\n2D X-ray (mosaic image, typically annotated with the regions of interest during data acquisition).\n2D X-ray tomogram (minimum intensity z-projection from 3D X-ray tomograms).",
    "Open Icy and an image pair from each row shown in Table 2[href=https://www.wicell.org#tbl2].\ntable:files/protocols_protocol_643_2.csv\nCritical: For each image opened in Icy, check that the metadata, such as pixel size and image dimensions, are correct. The metadata are shown in the right-hand bar of the Icy main display. Inspect the metadata and edit if needed (occasionally metadata are captured or read incorrectly by software and ec-CLEM will not be able to compute the transformation correctly if these details are incorrect).\nNote: Records of all metadata are saved in <filename>.xml files in the working directory (generated automatically when a file is first opened in Icy). Deleting an .xml file will allow Icy to read the metadata anew next time the corresponding dataset is read if needed.\nOpen eC-CLEM and assign the source/target images according to Table 2[href=https://www.wicell.org#tbl2].\nChoose the transformation model to be ‘Rigid’ and the noise model to be ‘Isotropic’.\nPress the play button.\nAdd fiducial markers to each of the images, moving paired points to corresponding features in each image. Rotate the field of view of an image if it helps with finding the same area in both images by right-clicking and dragging the mouse cursor. Use image features such as: Fiducial markers e.g., gold nanoparticles. High contrast cellular features e.g., nuclei or lipid droplets. Extraneous features e.g., cracks in ice or foreign objects such as dust particles. Features of the grid support film such as holes and tears.\nNote: If it is difficult to locate corresponding features in each image to place any fiducial markers, refer to the troubleshooting section in this paper.",
    "Critical: When finding locations for placing fiducial markers, only rotate the image using the right mouse button as this will not permanently alter image properties. Note that images may be flipped with respect to each other. Do not use Icy’s flip tool or other image transformation tools that are not a part of ec-CLEM, since such changes will not be tracked by ec-CLEM and the final transformation schema will not be correct. Instead, place 2–3 points and compute the transform in ec-CLEM which will reposition the image during the transformation, after which you can place more points and re-compute the transform. See more information on this in the troubleshooting section.\nNote: In Icy, you can zoom in and out of an image using the mouse scroll wheel. The image will zoom to the location of the mouse pointer on the image.\nClick on update transform after placing 3–10 points. The transformation files will be automatically saved in the same folder as the source images. Three files are saved per computation: a .csv file containing the transformation matrix, and two .xml files with the suffixes ‘.transformation’ and ‘.transformation_schema’ which contain information on the transformation. The files required for computing the final 3D transformation are the .xml file with the suffix ‘transformation_schema’.\nAdd more points if required and re-compute the transform. The two images can be locked at this point by choosing the same numbered lock icon in the top left of both views to make it easier to synchronously zoom into both images at the same location.",
    "Note: Lock 1 and Lock 2 will fully synchronize windows. Lock 3 synchronizes in 2D as well as zooming in/out, but not in z. At this stage in the protocol, use Lock 1. Check that the transformation is accurate by merging the images (merge button in ec-CLEM). The color and intensity of each image can be adjusted in the histogram bar in Icy located under the Sequence tab.\nClick on stop and check the output panel. It should say that the transformation has been saved and state its directory:\nTransformation schema saved at:\n<filepath>\\<filename>.transformation_schema.xml\nCSV format transformation saved at:\n<filepath>\\<filename>.transformation.csv\nXML format transformation saved at:\n<filepath>\\<filename>.transformation.xml\nYou do not need to save the registered image for this protocol. All the information required for subsequent steps is located within the xml files.\nRepeat with the remaining data combinations from Table2[href=https://www.wicell.org#tbl2] until you have three transformation schema files, one for each data pair.\nCreate a final transformation schema and apply to the 3D image stacks:\nOpen ec-CLEM in Icy, click advanced options and choose compute cascading transformation schema.\nAdd the transformation schema files (with suffix .transformation_schema.xml) for each image pair in the same order as shown in Table 2[href=https://www.wicell.org#tbl2].\nAdd a Save location for the new 3D transformation schema file, ensuring you add .xml at the end of the filename you choose.\nPress play to compute and save it.\nOpen the 3D image stacks corresponding to the aligned 2D SIR image (<filename>_SIR.dv or <filename>_SIR_ALN.dv if chromatic correction was performed) and the X-ray tomogram in Icy.\nIn the ec-CLEM advanced options, click Apply Transformation Schema\nApply the new 3D schema to the SIR image stack.\nSave the transformed image stack (Save As…).\nRegister the 3D stacks in the z direction:",
    "Open the transformed SIR image stack and the 3D X-ray tomogram image stack (.rec) in Icy and use ec-CLEM in the same way as detailed in Step 17f to add fiducial markers, but this time to register images in 3D.\nNote that you should keep the RIGID option to ensure no data deformation.\nNote: Be aware that choosing fiducials that are highly concentrated in one area of the volume examined can result in 3D alignments that are skewed. If RIGID 3D alignment fails consistently to produce full volume alignment (some areas are better aligned than others) and the fiducials chosen are spread evenly across data volumes, AFFINE alignment can be chosen on the understanding that the SIM data will suffer a degree of deformation likely along the z axis.\nNote: Lock both volumes (they are now pre-aligned in 2D) using Lock 3. Note that the datasets are not aligned in z at this stage of the process and common features should be present at similar x and y but different ‘heights’ in z.\nPlace between 5–10 points or until any further improvement cannot be seen, using features such as nanoparticles as your fiducials.\nClick stop. All process parameters are saved within .csv and .transformation_schema files.\nSave the transformed image stacks and/or the merged images. This step can be time consuming and you can consider the ‘SaveAsTifFast plugin’ (simply search for it in the Icy search bar). This uses a faster ImageJ version of saving.\nThe fully aligned datasets can now be viewed in any relevant 3D visualization package such as ChimeraX (Goddard et al., 2018[href=https://www.wicell.org#bib3]; Pettersen et al., 2021[href=https://www.wicell.org#bib12]).",
    "Critical: Ensure you use ‘Lock 3’ when doing z channel registration in ec-CLEM. Each dataset needs to be at the corresponding z slice that features a shared feature before a fiducial marker is placed there (shared features will be located at different depths in the respective stacks before alignment). To retrospectively change the position of a fiducial in z, either switch to 3D VTK view or use the ROI panel, select an ROI and change its Z position.\nOptional: Z-alignment can also be done by observing the SIR image stack as an orthogonal view. In Icy click on the drop-down arrow in the top left of the image and change it from 2D to OrthoViewer. This may help to more accurately place the point in the center of the point spread function of fluorescent points but active rendering is computationally demanding and is therefore likely to slow hardware performance.\nEvaluation of results\nTiming: 5 min–30 min\nAccuracy of the co-registration can be evaluated in ec-CLEM, through two types of error calculations: an error map showing the general distribution of positional offsets in the whole image (Figure 4[href=https://www.wicell.org#fig4]A), or individual fiducial marker errors (Figure 4[href=https://www.wicell.org#fig4]C). The histogram of the error map can be generated in Icy to view the distribution of the error (Figure 4[href=https://www.wicell.org#fig4]B)\nimgsrc:https://prod-shared-star-protocols.s3.amazonaws.com/protocols/643-Fig4.jpg\nFigure 4. Demonstrations of the two types of registration error calculation in ec-CLEM\n(A) Error map.\n(B) Corresponding histogram to measure the distribution of the registration error.\n(C) Error between individual points, shown as a red line near the fiducial markers.\nGenerate an error map in ec-CLEM:\nAfter computing a transform, click Compute the whole predicted error map.\nThe error map can be scaled by adjusting the histogram.",
    "The appearance of the scale bar or color bar can be toggled under ‘layer’ in the right bar shown in Icy.\nThe maximum and minimum values on the color bar show the values of the maximum and minimum error.\nInstall the histogram plugin in Icy (search for “histogram” in Icy) to plot the error map distribution. The width of the plot on the x axis corresponds to the registration error and the y axis is the number of points with each error value. Also see Figure S3 in Kounatidis et al., 2020[href=https://www.wicell.org#bib6] for more details of measuring the registration error.\nMeasure the error between points used as landmarks by clicking on ‘show measured error’:\nZoom in to the fiducial points to see red lines corresponding to error bars.\nUse the ‘ruler helper’ tool in Icy to measure the length of each red line to obtain error magnitudes.\nCreating an image overlay of the tomogram on the SIR image\nTiming: 5 min–30 min\nOnce the transformation schema has been computed, it can also be used to overlay the tomogram on the full-size SIR image, without any loss in resolution, using the Correlative View plugin in Icy.\nDownload the Correlative View plugin and save it in your Icy plugins folder.\nInvert the transformation schema:\nIn ec-CLEM, go to Advanced→Invert schema. Choose the final combined transformation schema you created in step 18.\nEnsure that the schema has the file extension .xml (manually rename if needed).\nCreate a name for the new file, adding .xml at the end.\nClick run. Two new .xml output files will be created, the file you will need in the next step should have the suffix ‘matrixtransfo’.\nOpen the maximum intensity SIR image in Icy:",
    "Click the drop-down icon menu in the top-left of the image in Icy and find the Correlative View plugin.\nChoose the minimum intensity tomogram image that you want to superimpose.\nChoose the inverted transformation file that ends in ‘matrixtransfo’.\nThe overlay image will appear without any resolution loss (Figure 5[href=https://www.wicell.org#fig5]).\nimgsrc:https://prod-shared-star-protocols.s3.amazonaws.com/protocols/643-Fig5.jpg\nFigure 5. Overlay image produced of the tomogram transformed onto the SIR volume using the Correlative View Plugin\nThis can be done by inverting the transformation matrix used to transform the SIR image onto the tomogram."
  ],
  "subjectAreas": [
    "Microscopy",
    "Structural Biology"
  ],
  "bigAreas": [
    "Bioengineering & Technology",
    "Molecular Biology & Genetics"
  ]
}