{
  "id": 14799,
  "origin_website": "Jove",
  "title": "Cryo-Electron Microscopy Screening Automation across Multiple Grids using Smart Leginon",
  "procedures": [
    "To follow this protocol, depicted in Figure 2, Leginon 3.6+ needs to be installed on the microscope computer and on an additional Linux workstation, and Ptolemy needs to be installed on the Linux workstation. This protocol has been developed over several years using Thermo Fisher Scientific (TFS) Glacios and Krios microscopes. This protocol assumes that the reader has already configured Leginon, Appion15, the associated database, microscope calibrations, performed direct alignments on the microscope, and has set up two Leginon Applications: One for standard single particle collection and one for single particle collection with Ptolemy. Information for setting up Leginon is available here: https://emg.nysbc.org/redmine/projects/leginon/wiki/Leginon_Manual. Information for setting up Ptolemy within Leginon is available here: https://emg.nysbc.org/redmine/projects/leginon/wiki/Multi-grid_autoscreening. Download Leginon from http://leginon.org and Ptolemy from https://github.com/SMLC-NYSBC/ptolemy. Leginon is licensed under the Apache License, Version 2.0, and Ptolemy is licensed under CC BY-NC 4.0.\n1. Leginon usage\nStart Leginon\n\t\nOn the microscope Windows computer, close any Leginon clients, then re-open it. In the Linux workstation, open a terminal window and type start-leginon.py or the system's appropriate alias for starting Leginon.\nIn the new Leginon Setup window, select Create a new session and click Next.\nSelect the project from the dropdown list and click Next.\nLeave the Name as it is, select the correct holder for the microscope setup, and click Next.\nFor the description, enter relevant information such as the microscope name, grid/sample description, and experiment description, then click Next.\nFor the image directory, make sure the appropriate filesystem is selected, and that the full path is appropriate for saving images, then click Next.\nUnder Connect to clients, click Edit. In the dropdown menu, select all of the computers that should be connected and click the + button for each, then click OK and Next.",
    "Input the correct C2 aperture size and click Next. This value can be found in the Apertures tab of TFS TUI software.\nLeginon interface\n\t\nSelect Application from the toolbar and click Run.\nSelect the proper Application from the dropdown menu (click Show All if necessary). Set main to the Leginon computer and scope and camera to that respective computer, then click Run. The left side of the main Leginon window will populate with nodes.\n\t\tNOTE: The left panel shows all Leginon nodes. The green camera icon nodes are the images that will be saved: Grid, Square, Hole, and Exposure. Nodes with the target sign are lower magnification images for targeting the higher magnification images. The purple camera nodes are the nodes that are programmed to find eucentric z-height and eucentric focus. Additionally, there are nodes to align the Zero loss peak, monitor buffer cycle, monitor liquid nitrogen filling, collecting gain correction images, calculating ice thickness (IceT), and navigating the grid through different magnifications using stage and image shift.\nPresets manager\n\t\t\nClick on the Presets_Manager node. In that node, click the bottom icon for importing presets or the icon above that one to create a new preset from the current state of the microscope.\nIf the bottom icon is clicked, an Import Presets window will open. Select the correct TEM and digital camera, then click Find and select the most recent session with the desired presets. Highlight all desired presets and click Import, then click Done.",
    "NOTE: The Presets Manager node should now list all imported and created presets. It is recommended to have presets for several magnifications and focusing, including gr: Grid Magnification, sq: Square Magnification, hln: Hole Magnification, fan: Auto-focus, fcn: Central focus, enn: Exposure Magnification (trailing 'n' refers to nanoprobe). Typical preset parameters for each magnification are shown in Table 1, Table 2, and Table 3. Note that this protocol uses a C2 aperture size of 70 µm for the Glacios, 50 µm for the Krios with a Selectris X and Falcon 4i, and 100 µm for the Krios with a BioQuantum with a K3.\nNavigation and eucentric height\n\t\t\nTo become familiar with controlling the microscope through Leginon and to set the z-height of the grid, go to the Navigation node, select the gr preset at the top, and click on the red arrow to the right to send the preset settings to the microscope. The microscope should update after 1-2 s. Once updated, click the camera button to the right to acquire an image.\nUsing the cursor tool, select a grid square for where to move the stage. Click the sq magnification and then the red arrow to send to the microscope, and click the camera button to acquire an image.\nGo to the Z_Focus node and click the Simulate Target button at the top near the middle of the buttons. While images are being collected for stage tilt focusing, switch to correlation view and watch the peak to ensure that it is in the corner of the correlation image. Once focusing is finished, ensure the stage is set to the grid's z-height.\nComa correction\n\t\tNOTE: This sub-section assumes that direct alignments have already been performed and that coma corrections have not been performed.",
    "Navigate to an area of the grid that produces clear Thon rings, such as carbon substrate.\n\t\t\tNOTE: A cross-grating may be used if collection is to be done on a gold grid.\nIn the Beam_Tilt_Image settings, ensure that the Presets Order includes only fcn with four tilt directions at an angle of 0.005 radians.\nClick Simulate Target to create a Zemlin tableau. Click Tableau on the left side of the main window to view the tableau.\nCorrect for coma by comparing the left and right Fourier transforms with each other and the top and bottom Fourier transforms with each other. If the pairs of images are not identical, first click the cursor icon to the right of the image adjustments, then click slightly off of center in the Tableau image in the direction of the difference and wait for a new set of Fourier transforms to collect. Repeat until the Fourier transforms are identical.\n\t\t\tNOTE: Each Tableau click takes several seconds to complete, and no additional clicks should be made during this time.\nGain references\n\t\tNOTE: Skip this section if the camera has automatic hardware references.\n\t\t\nIn the Navigation node, send a low magnification preset, such as gr, and navigate to an area where there is no obstruction to the beam path.\nConfirm that the stage position is at a location not obstructed by the beam path by taking a medium magnification image using the sq or hln preset.\nSend the high magnification enn preset to the microscope.\nIn the Correction node settings, select the proper Instrument information and set up the Camera Configuration to match the collection settings.",
    "Collect a dark reference image by closing the column valves on the microscope, then in the Correction node, select Dark and Both Channels from the dropdown menus at the top and click the Acquire camera button to the right.\nOnce complete, select Bright from the dropdown menu and click Acquire. Leginon will open the column valves automatically.\nCheck that the gain was properly collected by selecting Corrected from the dropdown menu, clicking Acquire, and observing the resulting image.\nIce thickness reference image\n\t\t\nIf the microscope has an energy filter, then in the IceT node settings, check Collect ice thickness image, enter 395 for the Mean free path, and fill in the rest of the values for the setup.\nIf the microscope does not have an energy filter, then in the Navigation node, send the enn preset to the microscope and click Acquire. Make a note of the Mean pixel value on the left side. In the IceT node settings, check Calculate ice thickness from aperture limited scattering, enter 1055 for the ALS coefficient and the measured mean pixel value.\n\t\t\tNOTE: The values 395 and 1055 were determined for the TFS Krios and Glacios, respectively, as described previously16, and may need to be re-calibrated for different microscope configurations.\nImage dose calibration\n\t\t\nIn the Preset_Manager, select the enn preset and click the camera button (Acquire dose image for the selected preset). Check the measured dose on the bottom. If it is close to the expected value (typically between 30 and 70), click YES.\nPreset alignments\n\t\t\nIn the Preset_Manager, check all of the high magnification presets (enn, fcn, and fan) to make sure the image shift and beam shift are 0, 0.\nOn the microscope computer, navigate to a carbon area.",
    "On the Leginon computer in the Navigation node, acquire an image with the gr preset.\nFind an object of interest and go to that location using the cursor tool.\nAcquire an image with the hln preset and relocate a unique part of that object of interest to the center using the cursor tool.\nAcquire an image with the enn preset and relocate it to the same unique part of the object of interest using the cursor tool.\nSelect image shift from the pulldown menu and acquire an image with the hln preset. Relocate to the same unique part of the object of interest with the cursor tool.\nIn the Presets_Manager, select the hln preset, click the settings button, and import the image shift from Navigation by clicking the left green arrow next to the Image shift values.\nRepeat steps 2.9.7 and 2.9.8 for the sq and gr presets.\nGrid atlas\n\t\t\nOn the microscope computer, close column valves and retract the objective aperture. Go to the Grid_Targeting node. In settings, change the label of the grid. Choose the desired radius of the atlas (the maximum radius is 0.0009 m). Click OK. Then click the Calculate atlas calculator button at the top and click the green Play button ('Submit Targets').\nIn the Square_Targeting node, the grid images will be collected and stitched together to form an atlas. Zoom in and out using the dropdown menu and adjust contrast and brightness. Use the scroll bars to move throughout the grid.\nOnce the atlas is collected, insert the objective aperture if desired.\nIf the microscope has an energy filter, select a reference target in the center of a broken square, press the Play button, and proceed with ZLP alignment in the following sub-section. Otherwise, skip the ZLP alignment step.\nZLP alignment",
    "In the Align_ZLP node settings, select stage position to move the reference target and select preset manager as the mover. Deselect bypass conditioner, then press OK.\n\t\t\t​NOTE: ZLP alignment should now be configured so that the microscope periodically moves to the reference target and executes the camera's ZLP alignment routine. ZLP re-alignment times of 30 min and 60 min are typically safe for Gatan BioQuantum and TFS Selectris X energy filters, respectively. These values vary depending on energy filter conditions, including consistent humidity, consistent temperature, electro-magnetic field isolation, and vibration isolation.\nHole template targeting setup\n\t\t\nIn the Square_Targeting node, select multiple acquisition targets, then press Play.\nIn the Hole_Targeting node settings, make sure Allow user verification of selected targets and Queue up targets are checked. Also, check Skip automated hole finder for now. Click Apply, then OK.\nIn the main window, use Ctrl-Shift-right click to remove all targets. Select the acquisition cursor and place the targets. Select the focus cursor and place a focus target between the acquisition targets. Click Play.\nFor the next Hole_Targeting image, uncheck the Skip automated hole finder in settings, then click Apply and OK. Remove the auto targets with Ctrl-Shift-right click.\nSelect the ruler tool and measure the diameter across a hole. In Template settings, change the Final Template Diameter to the measured hole diameter. Do not change the Original Template Diameter. Click Test. If bright peaks are not in the center of each hole, increase the Final Template Diameter. When finished, click OK.\nIn the Threshold settings, choose a value for A that segments the holes individually when Test is clicked. Click OK when satisfied.\nIn the Blobs settings, input the values and click Test. The Max blobs value is 1 so only one blob shows up. Click OK.",
    "In Lattice settings, use the ruler tool to measure the distance between two holes (center to center). Input the value in Spacing and click Test. The one blob will turn into a lattice point. Click OK.\nGo to acquisition settings, and optimize the acquisition targets using ice thickness thresholds and the Test targeting button. Get ice thickness information by hovering over the lattice points.\nIf the acquisition targets aren't satisfactory, use the ruler tool to measure the distance and angle from the lattice point to the desired location for an acquisition target. Delete the previous Acquisition Target Template points. Click on Auto Fill, put 4 for the number of targets, and change the radius and angle to the measured values. Click OK. Check Apply ice thickness threshold on template-convolved acquisition targets.\nOnce satisfied with the lattice points and the ice thickness thresholds, click the Submit Targets button.\nRepeat any of the above steps as needed for each square that was selected. Submit the whole queue with the Submit Queued Targets button once all the square targets are submitted.\nLeginon will begin focusing and imaging each set of targets. In the Z_Focus node, make sure that the eucentric height is found properly.\nExposure template targeting setup\n\t\t\nIn the Exposure targeting node, hole magnification images will appear. Use Ctrl-Shift-right click to remove the auto targets.\nMeasure the diameter of a hole with the ruler tool. In the Template settings, input the diameter into Final Template Diameter and click Test. A peak should now be at the center of each hole. Adjust the Diameter values if necessary.\nIn the Threshold settings, adjust the A value until the binarized test image shows white areas only where holes are located.",
    "In the Blobs settings, click Test. One blob per segmented hole should appear. Increase the Border to remove the blobs from the edges of the image, if desired.\nIn the Lattice settings, click Test. Adjust parameters until all blobs have turned into lattice points. Click OK.\nClick on the ruler tool and measure the distance between two lattice points. In the Lattice settings, change Spacing to that distance.\nHover over each lattice point to see the mean intensity, mean thickness, standard deviation intensity, and standard deviation thickness. Make a note of the intensities for each lattice point and use them to set desired ice thickness parameters in the acquisition settings.\nMeasure the distance and angle from one lattice point to the center of 4 holes with the ruler tool. In the acquisition settings, delete the current focus targets. Click AutoFill, and change the radius and angle to the measured values. Click Test targeting, click OK, and click Submit Targets.\n\t\t\tNOTE: Leginon will find eucentric focus (Focus node) and collect exposures, which will appear in the Exposure node.\nOnce all targets are imaged, go to the Exposure_Targeting node to see the next hole image. In the settings, uncheck Allow for user verification of selected targets. Also, uncheck Queue up targets and Skip automated hole finder. Click OK and click Submit Targets.\n\t\t\tNOTE: Leginon will automatically collect images based on the settings configured above. See the images and metadata in Appion.\nChanges can be made during automated collection. For example, change the collection defocus range at any time by editing the enn preset in the Preset_Manager.\nIf collection needs to be stopped, end the queue by clicking the Abort and Abort Queue buttons in the Hole and Exposure nodes.",
    "Once the collection is finished, go to Application and click Kill, then go to File and click Exit.\n2. Smart Leginon Autoscreen usage\nCreate a Smart Leginon Template session\n\t\nFollow the instructions in Section 1 to start Leginon.\nGo to Application and click Run. In the Run Application window, select the Ptolemy Application (select Show All if necessary). Set main to the Leginon computer and scope and camera to that respective computer.\nIn the Preset_Manager, import presets as described in step 1.2.3.\nConfigure node settings.\n\t\t\nIn the Square_Targeting node settings, make sure Sort targets by shortest path and Enable auto targeting are checked (Supplementary Figure 1A).\nIn the Square node settings, make sure Wait for node to process the image is checked. Add the Square preset to the list on the right from the dropdown menu if it is not already there. In Advanced settings, check set these apertures while imaging and ensure that the values for the two apertures are correct (Supplementary Figure 1B).\nIn the Hole_Targeting node settings, check Allow for user verification of selected targets. Uncheck Queue up targets and Skip automated hole finder (Supplementary Figure 2A).\nIn the Hole node setting, check Wait for a node to process the image and the Hole preset is in the list on the right. In Advanced settings, check set these apertures while imaging and ensure that the values for the two apertures are correct (Supplementary Figure 2B).\nIn the Exposure_Targeting node settings, check Allow for user verification of selected targets. Uncheck Queue up targets and Skip automated hole finder (Supplementary Figure 3A).",
    "In the Exposure node settings, make sure Wait for a node to process the image is unchecked, the Exposure preset is listed on the right, and in Advance settings, check set these apertures while imaging and ensure that the values for the two apertures are correct (Supplementary Figure 3B).\nIn the Focus node settings, make sure Wait for a node to process the image is unchecked, the Auto-focusing preset is listed on the right, and the Desired autofocus accuracy is set to 4 x 10-6 m (Supplementary Figure 4A).\nIn the Focus node Focus Sequence (next to the settings button), enable only two Beam Tilt Auto-focusing steps (Supplementary Figure 4B,C).\nIn the Z_Focus node settings, make sure Wait for a node to process the image is unchecked, the Hole preset is listed on the right, and Desired autofocus accuracy is 5 x 10-5 m (Supplementary Figure 5A).\nIn the Z_Focus node Focus Sequence, enable only two low-magnification Stage Tilt steps (Supplementary Figure 5B,C).\nDetermine the grid's z-height as described in step 1.2.4.\nCollect an atlas as described in step 1.2.10.\nSet up square finder parameters.\n\t\t\nOnce the atlas has been collected, Ptolemy will locate squares in the Square_Targeting node. Each square will show a blue circle, called a blob. When hovering over each blob, Leginon will report their size as calculated by Ptolemy. Make note of the largest and smallest blobs.\nIn the Thresholded settings, change the minimum and maximum Filter Range to include desirable squares and exclude undesirable squares.\nClick the Find Squares button in the top toolbar. Adjust the Filter Range until Find Squares targets well.\nIn the acquisition settings, choose values for the Max. number of targets and Number of target group to sample. These parameters will define how many squares and groups of squares are targeted.",
    "Once satisfied with the parameters, click the Play button. An example atlas after setup is shown in Supplementary Figure 6.\nSet up hole finder parameters.\n\t\t\nIn the Hole_Targeting node, use the ruler tool to measure the diameter of a hole.\nIn the Template settings, input the diameter into Final Template Diameter and click Test. Adjust the diameter until all holes have bright white peaks in the center.\nIn the Threshold settings, click Test. Adjust the A value until the binarized image shows white areas only where holes are located.\nIn the Blobs settings, choose to exclude Border targets by using the ruler to determine a minimum distance from the edge and inputting that value. Blobs may be filtered by their size, roundness, and number desired. Hover over blobs to show their values. Click Test to inspect current values.\nIn the Lattice settings, input the radius of the holes and spacing between holes (use the measuring tool),then click the 42 button to measure the Reference Intensity value of a vacuum area (empty hole or broken support film).\nIn the acquisition settings, check Use subset of the acquisition targets and set the Sample Maximal value to a small number, such as 2. Set a wide range of ice thickness means and standard deviations (measure these values by hovering over targets). Click Test targeting to randomize the target selection given the values above.\nClick the Play button when satisfied with all settings. Leginon will perform stage Z_Focus and collect the first target. An example image after setup is shown in Supplementary Figure 7.\nSet up exposure targeting parameters.",
    "In the Hole settings, set the Shell Script to the hl_finding.sh script path in the Ptolemy installation. Set the minimum score to accept to be ≤0. Input the radius of the holes (use the measuring tool), then click the 42 button to measure the Reference Intensity value of a vacuum area (empty hole or broken support film). Click Test to find the lattice of holes.\nIn acquisition settings, check Use subset of the acquisition targets and set the Sample Maximal value to a small number, such as 4, to collect on a subset of holes for screening. Set a wide range of ice thickness means and standard deviations (measure these values by hovering over targets).\nClick the Play button when satisfied with all settings. Leginon will perform eucentric Focus and collect high-magnification images, which can be seen in the Exposure node. An example image after setup is shown in Supplementary Figure 8.\nCheck the next Exposure_Targeting image to see if the settings above are still sufficient. Once satisfied, uncheck Allow for user verification of selected targets in the Exposure Targeting and Hole Targeting settings.\n\t\tNOTE: Screening should now be running unattended for the current grid. This session will be used as the template session for all grids.\nOnce the grid is done screening, click File > Exit to close Leginon.\nSet up Smart Leginon Autoscreen\n\t\nIn a terminal window, execute Smart Leginon's autoscreen.py.\nSelect gui, input a comma-separated list of grid slots to screen, input full for the workflow, input the template session name to base new sessions on (this can be found in Appion imageviewer), and input the template session's z-height value (Supplementary Figure 9).\nA gui will open to allow one to input the session name for each grid and select their respective project associations (Supplementary Figure 10).",
    "NOTE: Smart Leginon Autoscreen will now use the template session settings to automatically screen each grid and switch between grids unattended.\nFollow along during the collection in Leginon, Appion, and the microscope computer, or leave the microscope completely unattended.\n\t\tNOTE: Once all grids are screened, Smart Leginon will close the column valves on the microscope."
  ],
  "subjectAreas": [
    "Biochemistry"
  ],
  "bigAreas": [
    "Molecular Biology & Genetics"
  ]
}