{
  "id": 19988,
  "origin_website": "Wiley",
  "title": "Spatial Single Cell Analysis of Proteins in 2D Human Gastruloids Using Iterative Immunofluorescence",
  "procedures": [
    "This section describes how to execute iterative immunofluorescence stains using commonplace IF reagents and collect the image data with a confocal microscope. The result of this Basic Protocol 1[href=https://currentprotocols.onlinelibrary.wiley.com/doi/10.1002/cpz1.915#cpz1915-prot-0001] is a collection of images of the same cells over multiple rounds of staining that can be analyzed for protein expression, cell signaling, and spatial organization.\nMaterials\nCells (see Support Protocol 2[href=https://currentprotocols.onlinelibrary.wiley.com/doi/10.1002/cpz1.915#cpz1915-prot-0004])\nDonkey block +/– Triton X-100 (see recipe[href=https://currentprotocols.onlinelibrary.wiley.com/doi/10.1002/cpz1.915#cpz1915-rec-0003])\nElution buffer (EB) (see recipe[href=https://currentprotocols.onlinelibrary.wiley.com/doi/10.1002/cpz1.915#cpz1915-rec-0004])\nPBS, without Ca and Mg (Corning, cat. no. 21-040-CV)\nSodium azide (Sigma-Aldrich, cat. no. S8032-25G)\nPrimary antibody solution (see recipe[href=https://currentprotocols.onlinelibrary.wiley.com/doi/10.1002/cpz1.915#cpz1915-rec-0006])\nPBST (see recipe[href=https://currentprotocols.onlinelibrary.wiley.com/doi/10.1002/cpz1.915#cpz1915-rec-0006])\nSecondary antibody solution (see recipe[href=https://currentprotocols.onlinelibrary.wiley.com/doi/10.1002/cpz1.915#cpz1915-rec-0002])\nImaging buffer (IB) (see recipe[href=https://currentprotocols.onlinelibrary.wiley.com/doi/10.1002/cpz1.915#cpz1915-rec-0005])\nOrbital shaker\nSpinning disk confocal microscope\n               \nInverted microscope (Nikon Eclipse Ti2)\nSpinning disk (Yokogawa CSU-X1)\nObjective (Nikon PLAN APO 40×/1.25 SIL)\nLaser lines (405/488/561/640 nm)\nSoftware (NIS-Elements AR 5.41.02, build 1711)\nGlass cleaner\nLens paper\nJOBS protocol for NIS-Elements (see Data Availability Statement)\nStitching script (optional) (see Data Availability Statement)\nTransfer script (optional) (see Data Availability Statement)\nImmersion oil (Olympus SIL300CS-30CC)\n14-ml conical tubes\n1.5-ml Eppendorf tubes\nMarker\nNitrile examination gloves, powder-free\nLab safety glasses\nLab coat\n1-, 20-, 200- and 1000-µl pipette tips and pipettes\nSerological pipettes\nPre-treat with elution buffer\n1. Fix and store cells as described in Support Protocol 2[href=https://currentprotocols.onlinelibrary.wiley.com/doi/10.1002/cpz1.915#cpz1915-prot-0004].\n2. Replace storage medium with 70 µl donkey block containing Triton X-100.\nThis volume reflects the size of a single well in the 18-well ibidi chambered slide. Change the volume as appropriate for differently sized wells.\n3. Incubate at room temperature for 2 hr.\n4. Wash with 70 µl elution buffer (EB) 3 times for 10 min each.\n5. Wash with PBS 3 times to rinse out EB.\nThe sample can be stored in PBS with 0.01% sodium azide at 4°C for multiple days until ready to stain.\nPerform first stain",
    "6. Incubate sample in donkey block with Triton X-100 for 30 min at room temperature.\n7. Empty wells and add 70 µl primary antibody solution per well. Leave on the orbital shaker at 60 rpm for 3 hr at room temperature, protected from light.\n8. Wash with 70 µl PBST 3 times for 15 min each.\n9. Replace solution in wells with 70 µl secondary antibody solution.\n10. Incubate sample protected from light on the orbital shaker for 1 hr at 60 rpm, room temperature.\n11. Wash 2 times for 10 min each with PBST. Replace PBST with PBS.\n12. Store sample protected from light until ready to image.\nFirst round imaging\n13. Clean the objective with glass cleaner and gently wiping the lens with lens paper. Power on Nikon microscope, open NIS software, and focus on the sample.\n14. Click the “JOBS” tab, then click “Explorer.” Click “add” to add a new JOB protocol and import the JOBS protocol “230702_CP_JOBS.bin[href=https://currentprotocols.onlinelibrary.wiley.com/doi/10.1002/cpz1.915#support-information-section]” from the supplementary files (see Data Availability Statement).\nThis JOBS protocol enables imaging in a grid pattern based on the specified center location and can be saved and reused as needed. Alternatively, other approaches to allow repeated imaging of the same positions could be used. We perform stitching with a custom stitching script which is better than the built-in Nikon stitching. The protocol specifies imaging in the order z, then channels, then xy.\n15. Lower the speed of the XY stage movement to two arrows as shown in Figure 2[href=https://currentprotocols.onlinelibrary.wiley.com/doi/10.1002/cpz1.915#cpz1915-fig-0002], this prevents losing the oil droplet from rapid stage movement.\n<p>imgsrc:https://currentprotocols.onlinelibrary.wiley.com/cms/asset/79d01425-4bb5-4363-9217-c266627ad79d/cpz1915-fig-0002-m.jpg</p>\nFigure 2\nNikon joystick control box with XY speed lowered to 2 arrows. Control box showing adjusted XY speed to decrease risk of oil droplet displacement.",
    "16. If multiple wells are to be imaged, determine the order in which to image them. Replace the medium with 80 µl imaging buffer (IB) in only that well right before it is ready to be imaged.\nThis includes during imaging settings set-up and during position selection. Recall that samples should never be exposed to imaging light unless they are in IB.\n17. If imaging the first well, set the exposure and laser power settings for every channel with the guidelines discussed in the staining scheme section. Make note of the settings for later.\n18. Center the view of the microscope on the center of each colony to be imaged and click “Add” to the ND Acquisition table (shown in Fig. 3[href=https://currentprotocols.onlinelibrary.wiley.com/doi/10.1002/cpz1.915#cpz1915-fig-0003]). Pan around the colonies and set the z position to slightly lower than the lowest cell in the colony. Representative colonies should be selected.\nAlthough colonies are typically very reproducible, colonies can arise that deviate from the norm in density or have holes, and these should be avoided for simpler downstream analysis.\n<p>imgsrc:https://currentprotocols.onlinelibrary.wiley.com/cms/asset/7baf6029-c03d-447e-9848-4fde1e39c328/cpz1915-fig-0003-m.jpg</p>\nFigure 3\nND acquisition table. Set and adjust positions here.\n19. Save the XML file containing the list of positions to load during subsequent imaging.\nPositions can be loaded from this file and adjustments can be made if necessary to re-center positions. The positions file can be appended to contain all positions in all wells, or a new positions file can be saved for every well. We prefer to add all positions to a single file and check/uncheck the boxes that correspond to the proper wells as appropriate.",
    "20. Open the JOBS explorer and select the saved JOBS protocol from step 14. Click through the tabs on the left side of the window to ensure that all settings are correct and that only the correct well is selected in the “Select Wells” tab. Under the Storage tab, enter the desired file name and save location.\nThe folder names must be named in this format: “[date]_[experiment_name]_RD#_[stain1]_[stain2]_[stain3]” where # indicates which round number is being imaged (see “data” folder for examples, see Data Availability Statement).\n21. Click “Run” and you will be prompted to enter positions. Click “Load” and upload the XML file saved in step 19.\nMake sure only the boxes corresponding the correct positions for the current well undergoing imaging are checked. For example, if the second well is to be imaged, assuming 6 colonies are being imaged for each well, only boxes 7 to 12 should be checked. During imaging of the first well of round 1, only 6 positions will be saved (if imaging 6 colonies) because only the first well will have been examined at this point.\n22. Next, the user will be prompted to set the z range for every colony.\n         \nSelect “Symmetric Mode defined by range.”\nSet the z range to 1 µm.\nWith the channel set to the DAPI channel (405 nm), click “Live” and lower the z position as necessary until it is set below the lowest cells, such that when imaged, all cells’ entire z range will be captured in the image.\nClick “bottom” and then move up in z until just above the highest cell and click “top”.\nTurn off “Live” as soon as possible to avoid unnecessary light exposure.",
    "We set the number of z-slices on an individual basis per colony. Some variation is expected in the thickness of colonies. It is very important that cells are not cut off in z.\n23. Click “next” after the last position is set. This will automatically begin the image acquisition.\n24. Optional. Run the “stitchImages.m” script to monitor image acquisition in real time. This script periodically checks for new images, stitches them together, and saves these stitched images as TIFs for processing and jpgs for previewing.\n         \nCopy the stitchImages.m file into the destination folder of the unstitched nd2 images for every new round of imaging (recall that every round of imaging will be saved in its own subfolder within “data”).\nAdjust the grid size (default: 6 × 4) and the waiting time in this script as necessary.\nThen run the stitchImages script.\nStitching can also be run on a different computer by transferring the data to network storage during acquisition by first running the “Transfer.m” script on the computer connected to microscope. Open “Transfer.m” on MATLAB before or after image acquisition is started, and change “dir1” to the filepath of the images the microscope saves the new images into. Create a new folder in the network storage location with the same folder name. Change “dir2” to the filepath of the new folder created in the network storage. The advantage of stitching during imaging is that image quality can be monitored in real time. Issues such as oil droplet dislocation can be quickly corrected by restarting imaging if needed.\n25. Restart from step 16 to continue imaging all stained wells until they are all imaged.\nSome steps are not required to be repeated.",
    "26. Once all imaging is complete, replace IB in all wells with 0.01% sodium azide in PBS for overnight storage.\nRepeat staining until stain schedule is complete\n27. Elute existing stain by washing with 70 µl EB, 3 times for 10 min each.\nThis is normally done the morning after imaging is completed.\n28. Wash with 70 µl PBS 3 times to rinse out EB.\nRemoving all EB is important, otherwise residual EB could interfere with the primary staining.\n29. Incubate wells in 70 µl donkey block without Triton X-100 for 30 min at room temperature.\nNote that there should not be Triton X-100 in any solutions after round 1 of staining.\n30. Empty wells and add 70 µl primary antibody solution containing the appropriate antibody selections and leave on shaker at 60 rpm for 3 hr, protected from light.\n31. Wash sample with 70 µl PBST 3 times for 15 min each.\n32. Replace solution in wells with 70 µl secondary antibody solution.\n33. Incubate sample for 1 hr at room temperature protected from light on shaker (60 rpm).\n34. Wash with PBST 2 times for 10 min each.\n35. Store sample protected from light until ready to image.\nImaging of later round staining\n36. Load the XML file created from the first round of imaging (step 19), check the boxes corresponding to the correct colony positions within the target well.\n37. Replace PBS with IB in only the well that is about to be imaged.\n38. Check that the positions are correctly centered on the same colonies imaged during the first round of imaging, this includes checking that the z positioning is set beneath the lowest cell.\n39. Start imaging from the JOBS protocol as previously described and optionally run step 24 again.",
    "40. Store in 0.01% sodium azide in PBS overnight\n41. Repeat from step 27 until the antibody schedule is complete and all images are collected.",
    "This protocol extracts protein expression, cell signaling, and spatial information from images collected in Basic Protocol 1[href=https://currentprotocols.onlinelibrary.wiley.com/doi/10.1002/cpz1.915#cpz1915-prot-0001]. This data can be used to identify and quantify heterogenous cell types, describe combinatorial cell signaling patterns in these cell types, and determine how these phenomena are governed in space. This process involves stitching image grids and aligning images of different rounds, then segmenting (creating masks) for every cell, and finally reading-out single cell expression levels from these masks (process summarized in Fig. 4[href=https://currentprotocols.onlinelibrary.wiley.com/doi/10.1002/cpz1.915#cpz1915-fig-0004]). Our approach to cell segmentation uses the combination of two machine learning image segmentation tools, Ilastik (Berg et al., 2019[href=https://currentprotocols.onlinelibrary.wiley.com/doi/10.1002/cpz1.915#cpz1915-bib-0003]) and Cellpose (Pachitariu & Stringer, 2022[href=https://currentprotocols.onlinelibrary.wiley.com/doi/10.1002/cpz1.915#cpz1915-bib-0021]), to segment nuclei based on the DAPI stain from the first round of staining. Approximate cytoplasmic masks are then generated automatically by creating annuli around each nuclear mask (excluding neighboring nuclei). The key result of Basic Protocol 2[href=https://currentprotocols.onlinelibrary.wiley.com/doi/10.1002/cpz1.915#cpz1915-prot-0002] is a matrix of single cell intensity data for every stain that also includes spatial coordinates of the cell. This can then be used for further analysis of cell type heterogeneity, signaling, and spatial organization which we illustrate by creating UMAP plots, clustering fates, and making plots of spatial distribution of clusters as shown in Figure 1[href=https://currentprotocols.onlinelibrary.wiley.com/doi/10.1002/cpz1.915#cpz1915-fig-0001]. While prior coding experience is not required to follow the protocol, we recommend some basic familiarity with MATLAB and Python languages.\n<p>imgsrc:https://currentprotocols.onlinelibrary.wiley.com/cms/asset/6967fd3e-0471-4905-9341-f841c27d75a8/cpz1915-fig-0004-m.jpg</p>\nFigure 4\nOverview of the computational analysis pipeline. Computational analysis pipeline diagram.\nNecessary Resources\nMATLAB (2021a or newer, requires Imaging Processing Toolbox and Computer Vision Toolbox)\t\nScripts for image analysis included as supplementary files (see Data Availability Statement) and at github.com/idse/6i\nPython 3.8.0\nNumerous Python packages defined in supplementary file Mplex_analysis.yml including Cellpose (see Data Availability Statement)\nAnaconda (see Internet Resources), or another tool to set up a Python environment\nIlastik (1.3.3post3-OSX) (see Internet Resources)",
    "Stitching and alignment\n1. If not already performed in Basic Protocol 1[href=https://currentprotocols.onlinelibrary.wiley.com/doi/10.1002/cpz1.915#cpz1915-prot-0001] step 24, copy “stitchImages.m” into each folder containing unstitched nd2 files (i.e., each folder that corresponds to each round) and execute the scripts in each folder. Review the preview images for quality.\n2. Align images for the same colonies across different rounds of staining by running “AlignRounds.m”. For your own experiment, change the names of the folders listed in the “dirs” variable in line 11 to match the names of all the folders in your data set.\nA separate MIP image is created for every channel of a single colony. Since segmentation is only performed on the round 1 images and reused on later rounds, alignment is required for every cell to map back to its own mask based on its exact coordinates from round 1.\n3. Optional. Create RGB overlays of maximal intensity projection of any 3 stains from any round(s) by running “makeIFOverlays.m”. Select which stains to visualize by changing the channels variable in line 50. Note the first name in the list will be colored red, the second will be green, and the third will be blue. For your own experiment, change the name of the folders listed in the “dirs” variable in line 10 to match the names of all the folders of the rounds in your data set.\nThis can be used as another layer of quality control before segmentation. The script can also create cross section overlays, the stains that are visualized can be changed in line 89 by changing the names to the desired stain names.\nCell segmentation\n4. Create the Mplex_analysis environment.\nFor Mac computers\nOpen the terminal.\nNavigate to the “code[href=https://currentprotocols.onlinelibrary.wiley.com/doi/10.1002/cpz1.915#support-information-section]” folder from the supplementary files (see Data Availability Statement).\nEnter the following into the terminal:",
    "conda env create -f Mplex_analysis.yml\nFor Macs, this Mplex_analysis environment already contains the Cellpose installation.\nFor Windows computers\nOpen the anaconda prompt.\nNavigate to the “code” folder from the supplementary files (see Data Availability Statement).\nCreate the separate cellpose environment:\n               \nconda env create -f cellpose_environment.yml\n5. Activate the Mplex_analysis environment.\nFor Mac computers\nEnter conda activate Mplex_analysis to activate the environment, then enter jupyter lab to launch JupyterLab.\nFor Windows computers\nb.Enter conda activate cellpose then enter jupyter lab to launch JupyterLab.\n6. Copy ‘segmentation_cellpose.ipynb’ into the round 1 folder containing the stitched images and launch jupyter notebook. Run Cellpose cell segmentation from this script.\nDepending on the number of z-slices and images, this could take hours. The “diameter” parameter is set to 35, this number should be adjusted depending on the microscope and objective being used.\n7. Open Ilastik and select “Pixel Classification” under “Create New Project.” Select a folder to save the ilastik project file into.\n8. Click the “Add New” button under the empty table header, then click “Add separate Image(s)” and add representative images from the DAPI channel from the first round of staining as the training data. These will have filenames of the format “stitched_pxxxx_w0000_t0000.tif” where p indicates the colony (p0000 represents the first colony imaged), w the channel (w0000 being the DAPI channel), and t the time (which is always t0000 given that these are fixed samples).",
    "This pipeline only uses the DAPI nuclear staining from the first round of imaging for segmentation. For training the classifier, it is best to use several images that cover variation between images so that it works properly on all images when ready to batch process. Our pipeline only requires creating nuclear masks because the downstream single cell quantification measures cytoplasmic levels in an annulus (with some margin) around each nucleus. The cytoplasmic levels are measured in the z slice where the nucleus is most in focus.\n9. Navigate to the Feature Selection tab on the left of the window, click Select Features and highlight all boxes in the Features window (shown in Fig. 5[href=https://currentprotocols.onlinelibrary.wiley.com/doi/10.1002/cpz1.915#cpz1915-fig-0005]) then click ‘OK’.\n<p>imgsrc:https://currentprotocols.onlinelibrary.wiley.com/cms/asset/e9da1bd8-a4d5-4d93-9605-a3d32dd95412/cpz1915-fig-0005-m.jpg</p>\nFigure 5\nIlastik Features Window. Ilastik Training Features selections.\n10. Click the Training tab and create labels for pixels that are cells versus background, we use “Label 1” as cell and “Label 2” as non-cell background.\nThere is a contrast button next to the eraser icon to adjust the contrast of the image if cells are not visible when first viewing the preview. Click the contrast adjuster and then click and drag the mouse over the image to change the contrast.\n11. Create masks by drawing over cell nuclei and background areas with the correct labels as illustrated in Figure 6[href=https://currentprotocols.onlinelibrary.wiley.com/doi/10.1002/cpz1.915#cpz1915-fig-0006]. Scroll through different z slices by using the “time” scrollbar at the bottom right of the window (this is not “time” but z slices). Click “Live update” and then check “segmentation” under Group visibility to view how well the classifier is performing on all the pixels.",
    "Continue drawing labels over cells and background until the segmentation labels accurately depict cell vs non-cell pixels. Be sure to train on multiple z slices from the bottom and top of the colony, and then on multiple colonies.\n<p>imgsrc:https://currentprotocols.onlinelibrary.wiley.com/cms/asset/6f21441b-6dcf-46ce-8fba-f4081f3b8cf8/cpz1915-fig-0006-m.jpg</p>\nFigure 6\nCreating masks in Ilastik. Create cell masks by using the mouse to draw over nuclei with Label 1 and background with Label 2. Entire nuclei do not have to be completely colored with the label. Segmentation is improved by taking care to ensure cells are separated from nearby cells as much as possible.\n12. Click “Prediction Export” and change the Source setting under “Export Settings” to “Simple Segmentation.” Then click the “Choose Export Image Settings” button and change the “Output File Info Format” to “compressed hdf5” then click “OK.”\n13. Click the Batch Processing tab on the left and then click the “Select Raw Data Files” button. Navigate to the round 1 image folder and highlight all TIF images from the first round of staining that correspond to the DAPI channel only. Click “Open.” Create the Ilastik masks by clicking “Process all files.”\n14. Run “combineSegmentations.m” once the Ilastik masks and the Cellpose masks are completed and saved.\nThe output of this script is the combined masks from Ilastik and Cellpose in multipage TIF images and 3D nuclear and cytoplasmic masks for each nucleus in .mat data files.\n15. Run “SingleCellQuantification.m” to obtain single-cell measurements and write the data into CSV format. For your own experiment, change the name of the folders listed in the “dirs.” variable in line 10 to match the names of all the folders of the rounds in your data set.",
    "The script will create a matrix where every row represents a single cell. Columns include the cell positions, characteristics of nuclear shape and size, nuclear and cytoplasmic intensity data from the stains, as well as background subtracted nuclear:cytoplasmic ratios to be used as proxies for cell signaling for some stains.\nSingle cell analysis\n16. Activate the Mplex_analysis environment if not already activated.\nFor Mac computers\nOpen the terminal.\nNavigate to the “code” folder.\nEnter conda activate Mplex_analysis to activate the environment, then enter jupyter lab to launch Jupyterlab.\nFor Windows computers\nd.Open the anaconda prompt.\ne.Navigate to the “code” folder.\nf.Create the Mplex_analysis environment before activating it.\nconda env create -f Mplex_analysis_windows.yml\nconda activate Mplex_analysis\ng.Enter jupyter lab to launch JupyterLab.\nUse the command conda deactivate to deactivate the Cellpose environment before activating a different environment.\n17. Open ‘MultiplexedSCAnalysis.ipynb’ and begin executing the code blocks in the notebook and referenced in the following steps.\nThis jupyter notebook contains the starting code to analyze the csv generated from the cell segmentation section. Some blocks of code are not shown below, but all code should be run in the order shown in the notebook.\n18. Import all required python packages.\n         \nimport scprep\nimport numpy as np\nimport pandas as pd\nimport matplotlib.pyplot as plt\nimport seaborn as sb\nimport graphtools as gt\nfrom collections import Counter\nimport seaborn as sns\nimport tasklogger\nimport sklearn\nimport sklearn.cluster\nimport sklearn.mixture\nimport leidenalg as louvain\nimport umap\nfrom sklearn.manifold import TSNE\nfrom sklearn.cluster import SpectralClustering\nimport os\nfrom skimage import io as imio\nfrom skimage import exposure\nimport scipy\nfrom scipy.stats import gaussian_kde\nfrom scipy.stats import pearsonr\n19. Load the CSV file containing the processed image data using pandas.",
    "20. Define lists that distinguish stain categories such as transcription factors that mark cell type, versus stains that measure cell signaling.\nThe names of the stains in these lists must exactly match the column names in the CSV file.\nmarker_list = ['TFAP2C', 'TBXT', 'SOX17_1', 'ISL1', 'NANOG', 'SOX2', 'HAND1', 'OCT4', 'CDX2',\n'MIXL1', 'PRDM1', 'FOXA2', 'OTX2', 'SNAI1', 'EOMES', 'TBX6']\nsignal_list = ['cytopERK', 'pSmad1', 'BCAT', 'LEF1', 'ncSMAD2-3', 'ncYAP', 'cytopAKT']\nmeta_list = ['nucArea', 'nucVolume', 'nucZ', 'Z', 'nucMajorAxis', 'nucMinorAxis', 'nucCircularity',\n        'nucSolidity', 'Colony', 'X', 'Y', 'RadialDist'] # 'nucOrientation',\nkeep_list = ['DAPI_1'] + marker_list + signal_list + meta_list;\ndata = raw_data[keep_list]\ndata\n21. Proceed running the code blocks Inspect Overlays (optional) and Quality Control.\n22. Log transform the data.\n23. Visualize the data using UMAP dimensionality reduction and cluster cell types using Louvain.\n         \n# make UMAP based on marker genes alone\n# use min_dist to spread out points\ndata_log_umap = umap.UMAP(min_dist=0.4).fit_transform(data_log[marker_list])\ndata_log_umap = pd.DataFrame(data_log_umap, index=data_log.index)\nscprep.plot.scatter2d(data_log_umap, c=data_log['Colony'], label_prefix='UMAP',figsize=(5,5), ticks=False)\nplt.title('UMAP of marker genes')\nplt.show()\n# # louvain clustering with ONLY markers\nG = gt.Graph(data_log[marker_list])\nG_igraph = G.to_igraph()\nwith tasklogger.log_task('Louvain'):\n    partition = louvain.find_partition(G_igraph, louvain.RBConfigurationVertexPartition,\nweights='weight', resolution_parameter=0.2,seed=11)\n    louvain_clusters = np.array(partition.membership)\nlouvain_clusters\ndata_log['Cluster'] = louvain_clusters\nscprep.plot.scatter2d(u_cdata, c=louvain_clusters, shuffle=False,\n              title=curr_gene, ticks=None, label_prefix='UMAP',figsize=(7,7))\nplt.title('Louvain cluster over UMAP')\nplt.show()\nCell signaling analysis and cluster identification\n24. Using the list of cell-signaling readouts, create heatmaps that show differential cell signaling or marker expression across the identified cell type clusters.\n         \n# visualize\ncluster_means = pd.DataFrame(cluster_means, columns=data_log.columns[:-1],index=cluster_labels_reduced)\ncluster_means_zscore = pd.DataFrame(cluster_means_zscore, columns=data_log.columns[:-1],index=cluster_labels_reduced)\nrow_linkage = scipy.cluster.hierarchy.linkage(cluster_means_zscore[signal_list], method='average');\n# show signaling heatmap\ng = sb.clustermap(cluster_means_zscore[signal_list], row_linkage=row_linkage,xticklabels=signal_list,vmax=2,vmin=-2,dendrogram_ratio=0.1,figsize=(10,5),cbar_pos=(0.01,0.01,0.03,0.2),cmap='RdBu_r')\nplt.setp(g.ax_heatmap.get_yticklabels(), rotation=0)\nplt.setp(g.ax_heatmap.get_xticklabels(), rotation=80)\nplt.show()\n# show marker heatmap\ng = sb.clustermap(cluster_means_zscore[marker_list], row_linkage=row_linkage,xticklabels=marker_list,vmax=2,vmin=-2,dendrogram_ratio=0.1,figsize=(10,5),cbar_pos=(0.01,0.01,0.03,0.2),cmap='RdBu_r')\nplt.setp(g.ax_heatmap.get_yticklabels(), rotation=0)\nplt.setp(g.ax_heatmap.get_xticklabels(), rotation=80)\nplt.show()\nSpatial analysis\n25. Run the ‘Spatial Analysis’ code blocks to visualize the distribution of clusters in space.",
    "The code block will produce a scatterplot of the cluster identities over space projected onto the selected colony index. The settings can be adjusted to visualize all positions scattered together.\n# map the clusters back to space and overlay on DAPI image\ncoli = 2; # colony index\nRGBoverlay = makeRGBoverlay(coli, ['DAPI']);\nplt.rcParams['figure.figsize']=(8,8)\nfig, ax = plt.subplots()\nax.imshow(RGBoverlay, cmap='gray');\nax.axis('off');\nfor i in range(0,Nclusters):\n   idx = (data_log['Colony']==coli) & (data_log['Cluster']==i);\n   X = data_log.loc[idx]['X']\n   Y = data_log.loc[idx]['Y']\n   C = data_log.loc[idx]['Cluster']\n   scatter = ax.scatter(X,Y,s=15, edgecolors='none');\n  \nplt.legend(cluster_labels_reduced)\n26. Run the Radial Density code block to plot the average cluster density versus radial edge-distance.\n         \n# Cluster Radial Density\nplt.rcParams['figure.figsize']=(8,5)\nclusterdensities = {};\nr = np.linspace(0,350, num=350);\nclusterdensities_sum = 0*r;\nfor i in range(0,Nclusters):\n   idx = (data_log['Colony']==coli) & (data_log['Cluster']==i);\n   R = data_log.loc[idx]['RadialDist']\n   Z = gaussian_kde(R);\n   Ncells = len(R);\n   RZ = pd.concat([pd.Series(r),pd.Series(Z(r))],axis=1);\n   RZ.rename(columns={0:'r',1:'Z'}, inplace=True);\n   clusterdensity = Ncells*RZ['Z']/(2*3.14159*r)\n   clusterdensities[i] = clusterdensity;\n   clusterdensities_sum = clusterdensities_sum + clusterdensity;\n   \nfor i in range(0,Nclusters):\n   clusterfraction = clusterdensities[i]/clusterdensities_sum;\n   plt.plot(RZ['r'], clusterfraction);\nplt.ylabel('fraction of cells');\nplt.xlabel('distance from center');\nplt.legend(cluster_labels_reduced,loc='lower left',bbox_to_anchor=(0.01, 0.1));",
    "This protocol describes how to generate micropatterned multi-well slides using photolithography. This relies on exposing a photosensitive substrate to a particular wavelength that changes the substrate's molecular structure. In this case, PLL-g-PEG, a hydrophobic photoresist to which neither cells nor proteins can adhere, is exposed to shortwave UV through a mask (Azioune et al., 2010[href=https://currentprotocols.onlinelibrary.wiley.com/doi/10.1002/cpz1.915#cpz1915-bib-0001]). The specific areas where the PLL-g-PEG coated substrate is exposed to the UV light become hydrophilic and allow cell adherence. This method can be adapted to generate micropatterns of any desired geometry but requires the use of a custom designed photomask. We use 700 µm circular patterns with a pitch of 1100 µm to create 2D gastruloids, but CAD software can be utilized to customize the design of any photomask as needed.\nMaterials\nEthanol\nHEPES (Sigma-Aldrich, cat. no. H4034-25G)\nMilliQ H2O\nPLL-g-PEG (PLL:20K-G:35-PEG:2K) (JenKem Technology)\nPLL:20K-G:35-PEG:2K is a custom product with the formula: PEG-poly(L-lysine), poly(L-lysine), molecular weight of poly-lysine is 20,000 Da, molecular weight of mPEG is 2000 Da, graft ratio is 3.5+/−1.0, 100 mg.\nIsopropanol\ndH2O\nUltrasonic cleaner (Fosmon, cat. no. B07531F3GW)\nGlass coverslips for sticky slides (ibidi, cat. no. 10812)\nBunsen burner\nContainer for coverslips\nBiosafety cabinet\npH meter\nParafilm (Fisher Scientific, cat. no. 13-374-16)\n10-cm plate\nUV illuminator (Jelight Model 30 UVO cleaner)\nStraight-edge stainless steel forceps\nPlastic pipette tips\n50-ml tube\nKimwipes (Fisher Scientific, cat. no. 06-666)\nFume hood\nPhotomask, chrome on quartz (Applied Image)\nPaper towels\nSticky-slide 18 well (ibidi, cat. no. 81818-90)\nClamp and adapter for sticky slides (ibidi, cat. no. 80040 and 80045)\nCAD software, e.g., AutoCAD 2022 (see Internet Resources)\nPhotomask design files, 700um_photomask.dxf[href=https://currentprotocols.onlinelibrary.wiley.com/doi/10.1002/cpz1.915#support-information-section] and 700um_photomask.pdf[href=https://currentprotocols.onlinelibrary.wiley.com/doi/10.1002/cpz1.915#support-information-section] (see Supporting Information)\nCoat the glass coverslips with PLL-g-PEG\n1. Add 200 ml 70% ethanol in the ultrasonic cleaner, add the coverslips to be coated and sonicate coverslips for 15 min.",
    "2. Remove coverslips from the ultrasonic cleaner and flick away any ethanol. Pass them through a flame 3 to 4 times to sterilize.\n3. Place coverslips in a clean container and bring inside the biosafety cabinet to ensure a sterile environment.\n4. Make 10 mM HEPES buffer in MilliQ water and adjust pH to 7.45 to 7.50.\nThis solution can be stored up to 1 month at 4°C.\n5. Make 1 mg/ml PLL-g-PEG solution in 10 mM HEPES buffer. Make 150 µl aliquots and freeze immediately.\nThe aliquots are stable for 3 weeks and multiple freeze/thaw cycles should be avoided.\n6. Dilute an aliquot of 1 mg/ml PLL-g-PEG solution to a final concentration of 0.1 mg/ml in 10 mM HEPES solution.\n7. Stretch new parafilm across a 10-cm plate (or other covered holder) and UV illuminate in the biosafety cabinet for 15 min.\n8. Pipette 150 µl of 0.1 mg/ml PLL-g-PEG solution onto the parafilm.\nOur estimation allows for 10 micropatterned slides to be made through each run of the patterning protocol.\n9. Use straight edge forceps to carefully place a sterilized coverslip on top of the solution. Use plastic pipette tips to press down and remove any air bubbles to ensure an even coat.\n10. Cover the holding plate and stretch parafilm across the outer edges to seal it. Leave in the hood for 4 hr.\n11. Remove the coated coverslip from the holding plate and dunk twice in a 50-ml tube containing 45 to 50 ml of MilliQ water.\nBe careful to handle the coverslips with the forceps only from the edge.\n12. Flick away any excess water on a Kimwipe but be sure to keep the photoresist coated side of the coverslip face up and do not disturb the coating towards the center.",
    "13. Aspirate any leftover solution from the parafilm in the holding plate and place the coated coverslips face up back in the holding plates.\n14. Leave at room temperature until the next day.\nGenerate micropatterns by photolithography\n15. Inside a fume hood, place the photomask chrome side up in a tray and add isopropanol until it is covered. Leave for 2 min.\nThe custom designed photomask required in this step was acquired from Applied Image by submitting the supplemental .dxf drawing file (see Supporting Information). AutoCAD 2022 was used for the drawing of the custom design.\n16. Using straight-edge forceps, carefully remove the photomask from the tray and place on a paper towel. Place a large wet Kimwipe over top to remove excess isopropanol.\n17. Submerge the photomask in dH2O for 2 min.\n18. Remove from the dH2O and gently wipe down with a Kimwipe.\n19. Place inside the UV illuminator, chrome side up.\n20. Close UV illuminator and set for 10 min illumination.\n21. Open the illuminator after the 10 min exposure and add 43 µl MilliQ H2O on top of the mask, chrome side up.\nThis precise measurement of water is sufficient for covering the 75 mm × 25 mm coverslip area to act as contact medium without evaporating in the next step of 12 min illumination while also being a thin enough layer between the mask and glass coverslip to prevent UV light refraction.\n22. Slowly place the glass coverslip, coated side down on the mask being careful not to introduce air bubbles.\n23. Flip the photomask so chrome side with coverslip is down and close the lid.\n24. Illuminate for 12 min.\n25. Remove photomask and submerge chrome side up in a tray with dH2O.",
    "26. Wait 2 to 3 min until micropatterned coverslip floats to the top of the water. You may agitate the tray to speed this along.\n27. Pick up the coverslip from the edge with forceps and flick away excess water.\n28. Place the coverslip with the micropatterns face up on a Kimwipe.\nIt should be possible to observe the residual water pooling in the hydrophilic micropatterned areas.\n29. Place coverslip back in the holding plate until assembly.\nAssemble micropatterned multi-well slides\n30. Inside the biosafety cabinet, open the individually packed sticky slide, remove its lid and place in the clamp adapter for 18-well sticky slides.\n31. Remove the patterned glass coverslip with forceps and place on the flat part of the clamp adapter.\n32. Remove the protective film from the sticky slide and fit adapter together then slide fitted adapter into the clamp.\n33. Clamp tight for 2 min.\n34. Remove the assembled micropatterned slide from the clamp, place its lid back on and place it inside the holding plate once more. Label the edge with serial number as required.\n35. Store at 4°C.\nMicropatterned slides can be stored for up to a month before using.",
    "This protocol describes how to seed and use micropatterned coverslips to generate micropatterned pluripotent stem cell colonies. The 2D micropatterned gastruloid model is a powerful tool for studying human gastrulation. This system allows for human-specific insights, with a high degree of reproducibility, while at the same time, it remains easily manipulatable (Deglincerti et al., 2016[href=https://currentprotocols.onlinelibrary.wiley.com/doi/10.1002/cpz1.915#cpz1915-bib-0006]; Warmflash et al., 2014[href=https://currentprotocols.onlinelibrary.wiley.com/doi/10.1002/cpz1.915#cpz1915-bib-0029]). We present this protocol for the 2D-gastruloid model, but the technique is widely useful for many developmental inquiries (Blin, 2021[href=https://currentprotocols.onlinelibrary.wiley.com/doi/10.1002/cpz1.915#cpz1915-bib-0004]). Because the size and shape of micropatterns is customizable, micropatterning has been used in the study of organogenesis, including cardiac (Myers et al., 2013[href=https://currentprotocols.onlinelibrary.wiley.com/doi/10.1002/cpz1.915#cpz1915-bib-0020]), liver (Kaylan et al., 2018[href=https://currentprotocols.onlinelibrary.wiley.com/doi/10.1002/cpz1.915#cpz1915-bib-0017]), and pancreatic development (Tran et al., 2020[href=https://currentprotocols.onlinelibrary.wiley.com/doi/10.1002/cpz1.915#cpz1915-bib-0027]).\nAdditional Materials (also see Basic Protocol 1[href=https://currentprotocols.onlinelibrary.wiley.com/doi/10.1002/cpz1.915#cpz1915-prot-0001] and Support Protocol 1[href=https://currentprotocols.onlinelibrary.wiley.com/doi/10.1002/cpz1.915#cpz1915-prot-0003])\nLaminin-521 (Biolamina, cat. no. LN521)\nDPBS, with Ca and Mg (Gibco, cat. no. 14-040-182)\nAccutase (Fisher Scientific, cat. no. NC9464543)\nmTeSR1 medium (Stemcell Technologies, cat. no. 85850)\nROCK inhibitor (RI) Y-27632 (MedChem Express, cat. no. HY-10583)\nHuman pluripotent stem cells (hPSCs), ESI-017 cell line (ESI BIO, cat. no. ES-700)\nRecombinant human BMP-4 protein, CF (Fisher Scientific, cat. no. 314BP050CF)\n10,000 U/ml penicillin-streptomycin (Fisher Scientific, cat. no. 15-140-148)\n4% paraformaldehyde (PFA) fixative (see recipe)\nIncubator, 37°C, 5% CO2\nBenchtop centrifuge\nHemocytometer\nLight microscope with 5× objective\nLaminin coating micropatterns\n1. Dilute laminin 1:20 (final 5 µg/ml) in room temperature DPBS.\n2. Coat each well with 70 µl laminin solution and incubate 2 hr at 37°C.\n3. Without removing the laminin solution, add 100 µl DPBS, then remove 100 µl from well(s).\n4. Repeat this partial wash 3 more times.\n5. Remove all solution from the well(s). Quickly pipette 100 µl DPBS in and out of the well(s).\n6. Before the well(s) dry, replenish them with 100 µl DPBS for storage.",
    "It is critical that wells do not dry out.\n7. Store at 4°C.\nCoated wells will be stable in storage for up to 5 days.\nSeeding cells onto micropatterns\n8. Remove laminin coated plate from 4°C and place in cell incubator for 15 to 30 min.\nContinue to passaging in step 9 during incubation wait time.\n9. Generate single cell suspension of pluripotent cells using accutase, spin the suspension 4 min at 1000 × g, room temperature, and resuspend the cells in mTeSR with 10 µM RI.\nFor the example experiment in this article, we used ESI-017 cells at passage 49. We maintain the cells in a 6-cm dish. For consistent results, it is important to monitor the confluency at the time of passaging. We passaged the cells for this experiment at ∼75% confluency.\n10. Count cells using a hemocytometer and seed 160,000 cells/0.34 cm2.\nEach well in the 18-well ibidi slide has a growth area of 0.34 cm2, we seed 160,000 cells in each well.\nEnsure passaged cells are well mixed before seeding cells in each well. Let the cells sink to the bottom of the well(s) by resting the slide for 10 min in the biosafety cabinet before moving.\n11. Move to the incubator for 35 min.\nThis is sufficient time for ESI-017 hPSCs to sink and adhere to the patterns; different cell lines may require more or less time depending on environmental conditions.\n12. Remove medium, wash with PBS (without Ca and Mg).\n13. Add mTeSR medium containing 10 µM RI. Do not let cells dry out.\n14. Check under the microscope to confirm intact patterns without holes.\n15. After 1 hr, change medium for 200 µl/well medium containing 50 ng/ml BMP-4 + 100 U/ml penicillin-streptomycin without RI.",
    "16. Incubate cells at 37°C and 5% CO2 for 42 hr or 48 hr after addition of BMP-4.\nFixation\n17. Wash 2 times with 150 µl PBS (without Ca and Mg).\n18. Fix with 70 μl of 4% PFA/well for 20 min.\n19. Wash 2 times with 150 µl PBS (without Ca and Mg).\n20. Store in PBS with 0.01% sodium azide at 4°C until ready to stain.\n21. Continue to step 2 in Basic Protocol 1[href=https://currentprotocols.onlinelibrary.wiley.com/doi/10.1002/cpz1.915#cpz1915-prot-0001] for staining instructions."
  ],
  "subjectAreas": [
    "Stem Cell Biology"
  ],
  "bigAreas": [
    "Biomedical & Clinical Research"
  ]
}