{
  "id": 1906,
  "origin_website": "Cell",
  "title": "A protocol to extract cell-type-specific signatures from differentially expressed genes in bulk-tissue RNA-seq",
  "procedures": [
    "Step-by-step method details\nStep-by-step method details\nStep 1: Load differentially expressed genes (DEGs) between the different sample groups and set a common filter based on Adjusted p value (padj)\nTiming: 5 min\nThis step loads the DEGs between the different contrasts for downstream analysis. DEGs with an padj < 0.1 based on sublayer differences for control and epileptic condition are retained. See bulk gene expression signatures from highly heterogeneous tissue in cell-type composition[href=https://www.wicell.org#sec1.1] in the “before you begin[href=https://www.wicell.org#before-you-begin]” section.\nLoad the DEGs tables into dataframes.\nSet the working directory path to the RNA-seq data folder.\n> path = \"∼/Differentially_expressed_gene_tables/\"\n> setwd(path)\nRead the RNA-seq data from disk.\n>ctrl_DEGs<- read.delim(\"Sup_deep_diff_in_controls_FullTable.tsv\", stringAsFactors = FALSE)\n>epil_DEGs<- read.delim(\"Sup_deep_diff_in_epilepsy_FullTable.tsv\", stringAsFactors = FALSE)\nNote: The DEGs between CA1 sublayers in control and epileptic condition are available as Data Table 1 and Data Table 2 (see “before you begin[href=https://www.wicell.org#before-you-begin]” section and “key resources table[href=https://www.wicell.org#key-resources-table]”). These data are also available in the Resource web application for the LCM-RNA-seq data from Cid et al. (2021)[href=https://www.wicell.org#bib7]: http://lopezatalayalab.in.umh-csic.es/CA1_Sublayers_&_Epilepsy[href=http://lopezatalayalab.in.umh-csic.es/CA1_Sublayers_%26_Epilepsy].\nRemove DEGs table rows with empty gene symbols.\n> ctrl_DEGs <- ctrl_DEGs[!is.na(ctrl_DEGs$Gene_symbol),]\n> epil_DEGs <- epil_DEGs[!is.na(epil_DEGs$Gene_symbol),]\nFilter the DEGs tables by significance (padj < 0.1).\n> ctrl_DEGs <- ctrl_DEGs[ctrl_DEGs$padj < 0.1,]\n> epil_DEGs <- epil_DEGs[epil_DEGs$padj < 0.1,]\nRank the DEGs tables by fold-change.\n> ctrl_DEGs <- ctrl_DEGs[order(-ctrl_DEGs$log2FoldChange),]\n> epil_DEGs <- epil_DEGs[order(-epil_DEGs$log2FoldChange),]\nSubset DEGs tables based on the layer they are enriched in controls and in epileptics.\n> ctrl_DEGs_sup <- ctrl_DEGs[ctrl_DEGs$log2FoldChange > 0,]\n> ctrl_DEGs_deep <- ctrl_DEGs[ctrl_DEGs$log2FoldChange < 0,]\n> epil_DEGs_sup <- epil_DEGs[epil_DEGs$log2FoldChange > 0,]\n> epil_DEGs_deep <- epil_DEGs[epil_DEGs$log2FoldChange < 0,]\nGet DEGs lists, extracting gene symbols from DEGs tables.\n> ctrl_DEGs_sup <- ctrl_DEGs_sup$Gene_symbol\n> ctrl_DEGs_deep <- ctrl_DEGs_deep$Gene_symbol\n> epil_DEGs_sup <- epil_DEGs_sup$Gene_symbol\n> epil_DEGs_deep <- epil_DEGs_deep$Gene_symbol\nStep 2: Load the single-cell expression dataset and build the single-cell dataset object\nTiming: 20 min",
    "This step loads the original scRNA-seq dataset and builds the single-cell dataset object. See reference dataset of single-cell type-specific expression profiles[href=https://www.wicell.org#sec1.2] in the “before you begin[href=https://www.wicell.org#before-you-begin]” section.\nLoad the single-cell gene expression matrix and cell metadata.\nSet the working directory path to a single-cell RNA-seq data folder.\n> path = \"∼/AllenBrainMap_MouseCortexAndHippo_SMART-seq/\"\n> setwd(path)\nRead the single-cell RNA-seq metadata from disk.\n> metadata <- read.csv(file = \"metadata.csv\", row.names = 1)\nLoad the data.table library, to access the fread() function, a very efficient tool to read regular delimited files from disk.\n> library(data.table)\nRead the single-cell RNA-seq counts from disk.\n> counts <- fread(\"matrix.csv\", data.table = FALSE)\nSet the cell barcodes as rownames.\n> rownames(counts) <- counts$sample_name\nRemove the column sample_name to have a count matrix.\n> counts <- counts[,-!names(counts) %in% c(\"sample_name\")]\nSet the count matrix as a matrix.\n> counts <- as.matrix(counts)\nTranspose the counts matrix to get the correct format to be used as input in Seurat.\n> transposed_counts <- t(counts)\nRemove old count objects to free space.\n> rm(counts)\nFree memory through garbage collection.\n> gc()\nCritical: The gene-barcode matrix from the scRNA-seq dataset must be arranged so that each of the columns represents a barcode and each of the rows represents a gene (related to point 7.h.).\nBuild the Seurat single-cell dataset object.\nLoad the Seurat library.\n> library(Seurat)\nCreate the Seurat object with the transposed raw counts and cell metadata without filtering any cell or genes.\n>sc_data<- CreateSeuratObject(counts = transposed_counts,\n  meta.data = metadata, min.cells = 0, min.features = 0,\n  project =\"AllenBrainMap_MouseCortexHippo_SMART-seq-\n  2019_with_10x_SMART-seq-2020-taxonomy\")\nClean unneeded data.\nRemove transposed_counts and metadata objects to free space.\n> rm(transposed_counts)\n> rm(metadata)\nFree memory through garbage collection.\n> gc()\nStep 3: Subset scRNA-seq reference dataset to match cell-type populations in the bulk-tissue RNA-seq\nTiming: 10 min",
    "This step sets a subset of the scRNA-seq dataset to match the cell types present in the tissue processed for bulk RNA-seq.\nExplore the different cell metadata categories in the scRNA-seq object to select the categories more related to bulk-tissue RNA-seq data. The categories selected to perform the subset are “region_label” and “subclass_label”. See cell numbers in Tables 1[href=https://www.wicell.org#tbl1] and 2[href=https://www.wicell.org#tbl2].\ntable:files/protocols_protocol_1386_1.csv\ntable:files/protocols_protocol_1386_2.csv\n> str(sc_data@meta.data)\nNote: The number of cells can be consulted at any moment using the function table() with the associated category/metadata as argument.\n> table(sc_data$region_label)\n> table(sc_data$subclass_label)\nNote: Consider removing potential confounding factors (e.g. conditions or treatments) that are unrelated to the bulk-tissue RNA-seq from the initial scRNA-seq dataset.\nFilter out any cell population from tissue areas, treatments or other groups that are unrelated to the bulk-tissue RNA-seq data. Troubleshooting 1[href=https://www.wicell.org#sec7.1].\nWe first generate a scRNA-seq reference of the cells-types in the hippocampal CA1 region of the brain. The 74,973 cells in the initial scRNA-seq dataset are filtered to subset cells from hippocampal region and non-neuronal subclasses (Astro, Micro-PVM, Endo, Oligo or VLMC). Then, excitatory cells from CA2, CA3, DG and also a group of cells in a subclass without label ([No label]) are removed. This initial filtering extracts a subset of 5,506 cells.\n>sc_data<-subset(x = sc_data,\n  subset = region_label == \"HIP\" | subclass_label %in% c(\"Astro\",\"Micro-PVM\",\"Endo\",\"Oligo\",\"VLMC\"))\n>sc_data<-subset(x = sc_data,\n  cells = colnames(sc_data)[!sc_data$subclass_label %in% c(\"\",\"CA2\",\"CA3\",\"DG\")])\nOf these, cells labeled by subclass as CA1-ProS, Astro, Lamp5, Vip, Sncg, Sst, Oligo, Endo, Micro-PVM, VLMC, or Pvalb are retained for further analysis, remaining a total of 5,429 cells. See cell numbers in Tables 3[href=https://www.wicell.org#tbl3] and 4[href=https://www.wicell.org#tbl4]. Troubleshooting 2[href=https://www.wicell.org#sec7.3].\n>sc_data<-subset(x = sc_data,\n  cells = colnames(sc_data)[!sc_data$subclass_label %in%\n    c(\"L2 IT RHP\",\"L2/3 IT CTX-1\",\"L2/3 IT CTX-2\",\n      \"L2/3 IT ENTl\",\"L2/3 IT PPP\",\"L5 IT TPE-ENT\",\n      \"L6 CT CTX\",\"L6b CTX\",\"Meis2\",\"NP SUB\",\"Sst Chodl\",\n      \"SUB-ProS\")])\nimgsrc:https://prod-shared-star-protocols.s3.amazonaws.com/protocols/1386-Fig1.jpg",
    "Figure 1. Major cell types present in the reference scRNA-seq dataset\nCell populations in scRNA-seq data from the Allen Brain Map portal (Mouse Whole Cortex and Hippocampus SMART-seq (2019) with 10x-SMART-seq taxonomy (2020) (Yao et al., 2021[href=https://www.wicell.org#bib25])) identified as non-neuronal or from CA1 (from “hippocampus” but not NA, “CA2”, “CA3” or “DG”) were subset and grouped in their corresponding major cell populations as follows: Astrocytes (Astro) (976 cells), Endothelial (Endo) (213 cells), Interneurons (Lamp5, Pvalb, Sncg, Sst, Vip) (2077 cells), Microglia (Micro-PVM) (176 cells), Mural (VLMC) (159 cells), Oligodendrocytes (Oligo) (236 cells) and Pyramidal (CA1-ProS) (1,592 cells). Left, Principal component analysis (PCA); Center, t-distributed stochastic neighbor embedding (tSNE); Right, uniform manifold approximation and projection (UMAP).\ntable:files/protocols_protocol_1386_3.csv\ntable:files/protocols_protocol_1386_4.csv\nRename and group the cells in their corresponding major cell populations.\nRemove unused levels (labels without associated cells). See cell numbers in Table 5[href=https://www.wicell.org#tbl5].\n>sc_data$subclass_label<- droplevels(x = sc_data$subclass_label)\ntable:files/protocols_protocol_1386_5.csv\nSet the “subclass_label” metadata as the “active.ident” (default identity class) for easy customization.\n> Idents(sc_data) <- \"subclass_label\"\nRename identity classes to the corresponding major cell population. The remaining 5,429 cells are grouped in their corresponding major cell populations as follows: Astrocytes (Astro) (976 cells), Endothelial (Endo) (213 cells), Interneurons (Lamp5, Pvalb, Sncg, Sst, Vip) (2,077 cells), Microglia (Micro-PVM) (176 cells), Mural (VLMC) (159 cells), Oligodendrocytes (Oligo) (236 cells) and Pyramidal (CA1-ProS) (1,592 cells). See Tables 5[href=https://www.wicell.org#tbl5] and 6[href=https://www.wicell.org#tbl6].\ntable:files/protocols_protocol_1386_6.csv\n>sc_data<-RenameIdents(sc_data,\n          \"Astro\" = \"Astrocytes\",\n          \"CA1-ProS\" = \"Pyramidal\",\n          \"Endo\" = \"Endothelial\",\n          \"Lamp5\" = \"Interneurons\",\n          \"Micro-PVM\" = \"Microglia\",\n          \"Oligo\" = \"Oligodendrocytes\",\n          \"Pvalb\" = \"Interneurons\",\n          \"Sncg\" = \"Interneurons\",\n          \"Sst\" = \"Interneurons\",\n          \"Vip\" = \"Interneurons\",\n          \"VLMC\" = \"Mural\")\nReorder alphabetically the identity classes. See cell numbers in Table 6[href=https://www.wicell.org#tbl6].\n>Idents(sc_data)<-factor(Idents(sc_data), levels = sort(levels(sc_data)))\nNormalize gene counts.\n> sc_data <- NormalizeData(sc_data, normalization.method = \"LogNormalize\", scale.factor = 10000)\nIdentify genes that are outliers on a 'mean variability plot'.",
    "> sc_data <- FindVariableFeatures(sc_data, selection.method = \"vst\", nfeatures = 2000)\nScale and center variable genes.\n> sc_data <- ScaleData(sc_data)\nPerform dimensionality reduction to summarize and visualize the cells in the low-dimensional space.\nPerform linear dimensionality reduction by PCA over the variable genes (default option).\n> sc_data <- RunPCA(sc_data)\nEstimate the number of principal components (PCs) that are biologically informative by plotting the standard deviations of the PCs for easy identification of an elbow in the graph (Elbow plot). This elbow often corresponds well with the significant dimensions that capture the majority of the variation in the data. Here, the elbow was identified at the 20th PC.\n> ElbowPlot(sc_data, ndims = 50)\nPerform non-linear dimensionality reduction over biologically informative dimensions from linear dimensionality reduction using stochastic nearest neighbors (tSNE) (van der Maaten and Hinton, 2009[href=https://www.wicell.org#bib15]) and uniform manifold approximation and projection (UMAP) (McInnes et al., 2018[href=https://www.wicell.org#bib16]) state-of-the-art techniques.\n> sc_data <- RunTSNE(sc_data, dims = 1:20)\n> sc_data <- RunUMAP(sc_data, dims = 1:20)\nPause point: Save the scRNA-seq object and resume the analysis in future R sessions without repeating the previous steps:\n> saveRDS(sc_data, \"Single-cell_custom_subset.rds\")\nTo reload the scRNA-seq object saved in a previous R session, use the following command:\n> sc_data <- readRDS(\"Single-cell_custom_subset.rds\")\nCreate a figure showing dimensionality reduction of major cell types (Figure 1[href=https://www.wicell.org#fig1]). Use custom labels from the scRNA-seq and the dimensionality reduction techniques applied to the data.\nLoad the cowplot library, to access the get_legend() function.\n> library(cowplot)\nLoad the patchwork library, to access the area() function.\n> library(patchwork)\nLoad the ggplot2 library, to access the ggsave() function.\n> library(ggplot2)\nGenerate the dimensionality reduction plots.\n>cols <-c(\"limegreen\", #Astrocytes\n                \"steelblue\", #Endothelial\n                \"mediumorchid4\", #Interneurons\n                \"firebricks2\", #Microglia\n                \"magenta\", #Mural\n                \"gray52\", #Oligodendrocytes\n                \"tan1\") #Pyramidal\n>pca_plot<-DimPlot(sc_data, reduction = \"pca\", pt.size = 0.1, label = T, cols = cols)",
    ">tsne_plot<-DimPlot(sc_data, reduction = \"tsne\", pt.size = 0.1, label = T, cols = cols)\n>umap_plot<-DimPlot(sc_data, reduction = \"umap\", pt.size = 0.1, label = T, cols = cols)\n>legend<-get_legend(umap_plot)\nDefine the figure layout.\n>layout<-c (area(1, 1, 1, 2),#PCA\n                    area(1, 3, 1, 4),#tSNE\n                    area(1, 5, 1, 6),#UMAP\n                    area(1, 7))#Legend\nBuild the figure.\n> fig1 <- pca_plot + tsne_plot + umap_plot + legend + plot_layout(design = layout) & NoLegend()\nSave the figure to disk.\n> ggsave(filename = \"Fig_1.png\", plot = fig1, width = 13, height = 3.75, dpi = 300)\nStep 4: Perform the deconvolution of cell-type-specific signal in bulk-tissue RNA-seq top DEGs using single-cell RNA-seq reference\nTiming: 10 min\nThis step subsets top DEGs lists of equal size for the groups of interest and imputes bulk signal to cell-type leveraging on the scRNA-seq subset from step 3.\nGet the list of genes names from the single-cell object.\n> gene_names <- rownames(sc_data)\nIntersect the DEGs lists with the list of genes names from the single-cell reference object, preserving the fold change order from point 4.\n> ctrl_DEGs_sup <- ctrl_DEGs_sup[ctrl_DEGs_sup %in% gene_names]\n> ctrl_DEGs_deep <- ctrl_DEGs_deep[ctrl_DEGs_deep %in% gene_names]\n> epil_DEGs_sup <- epil_DEGs_sup[epil_DEGs_sup %in% gene_names]\n> epil_DEGs_deep <- epil_DEGs_deep[epil_DEGs_deep %in% gene_names]\nOptional: In the case that the bulk-tissue RNA-seq and reference scRNA-seq dataset are from different species (e.g. rat vs. mouse), ortholog conversion should be performed. Troubleshooting 3[href=https://www.wicell.org#sec7.5].\nCapture comparable convoluted gene signatures by using gene sets of equal size that are differentially regulated between the experimental conditions. Subset top 250 differentially regulated genes for each sublayer and condition for further analysis, with the genes sorted in descending order by magnitude of change. Troubleshooting 4[href=https://www.wicell.org#sec7.7].\nimgsrc:https://prod-shared-star-protocols.s3.amazonaws.com/protocols/1386-Fig2.jpg\nFigure 2. Deconvolution of gene signatures from bulk-tissue RNA-seq reveals strong presence of reactive microglia in superficial CA1 sublayer of the hippocampus in epilepsy",
    "Patterns of cell-type-specific gene expression were identified by deconvolution of bulk-tissue transcriptome profiling of deep and superficial hippocampal CA1 sublayers of control and epileptic animals. This analysis reveals strong presence of reactive microglia in superficial CA1 sublayer in epilepsy. Gene sets were the top 250 DEGs between superficial and deep CA1 sublayers in epileptic and control rats identified in bulk-tissue RNA-seq. For the selected genes, normalized expression in single cells was retrieved from publicly available scRNA-seq data from the Allen Brain Map portal (Mouse Whole Cortex and Hippocampus SMART-seq (2019) with 10x-SMART-seq taxonomy (2020)) (Yao et al., 2021[href=https://www.wicell.org#bib25]) and single-cells were summarized by linear dimensionality reduction using PCA (top panels). Cells are colored by population membership (step 2). Hierarchical clustering heatmaps of pairwise correlations for all individual cells using scRNA-seq expression data for selected gene sets identified in differential expression analysis with bulk-tissue RNA-seq (top 250 DEGs) (bottom panels). Bona fide markers of distinct cell types are present in clusters of highly correlated genes representing cell-type gene signatures convoluted in the bulk-tissue RNA-seq. Patterns of cell-type-specific gene expression present in the bulk-tissue RNA-seq gene signatures of deep and superficial CA1 sublayers of control and epileptic animals lead to segregation of the individual cells in the corresponding PCAs and in the heatmap of the pairwise correlation matrices. Note the different distribution of distinct cell types in the deep and superficial (Sup) sublayers of the CA1 region in control and epileptic rats. Also note the presence of a strong gene signature of Micro in the Sup CA1 sublayer of epileptic rats (arrowhead). Names of highly correlated genes enriched in Micro are shown (Zeisel et al., 2018[href=https://www.wicell.org#bib27]). Pyr, pyramidal cells; Inter, interneurons; ODC, oligodendrocytes; Astro, astrocytes; Endo, endothelial cells; Micro, microglia; Mural, mural cells.",
    "Reprinted from Cid et al. (2021)[href=https://www.wicell.org#bib7], with permission from Elsevier.\n> ctrl_DEGs_sup <- head(ctrl_DEGs_sup,250)\n> ctrl_DEGs_deep <- rev(tail(ctrl_DEGs_deep,250))\n> epil_DEGs_sup <- head(epil_DEGs_sup,250)\n> epil_DEGs_deep <- rev(tail(epil_DEGs_deep,250))\nNote: In our case, we have 4 top DEGs lists that should be iteratively renamed to “topDEGs_list” in point 21 to generate the plots in Figure 2[href=https://www.wicell.org#fig2]. Our top DEGs lists are comparable in size, as they contain top 250 DEG genes, with the exception of “epil_DEGs_sup” that contains 230 genes.\nSet “topDEGs_list” as any of the previous 4 DEGs lists and repeat the following steps (21–25) for all the other lists, renaming the plot output names in points 24 and 25 to avoid overwriting the plots in the different iterations.\n>topDEGs_list<- ctrl_DEGs_sup    #Repeat steps 21-25 for each DEG list.\nScale the normalized scRNA-seq data for the top DEGs list.\n> sc_data <- ScaleData(sc_data, features = topDEGs_list)\nPerform dimensionality reduction of the gene list to summarize and visualize the cells in the low-dimensional space. Troubleshooting 5[href=https://www.wicell.org#sec7.9].\nPerform linear dimensionality reduction by PCA over the top DEGs.\n> sc_data <- RunPCA(sc_data, features = topDEGs_list)\nRetain genes with variance. This gene list will be used to perform pairwise Pearson correlation coefficients (related to point 25.e.).\n>topDEGs_list<- rownames(sc_data@reductions[[\"pca\"]]@feature.loadings)\nGenerate the dimensionality reduction plots and save them to disk. For Figure 2[href=https://www.wicell.org#fig2] we use the PCA plots with labels set to false, to maximize visualization.\n>pca_plot<- Dimplot(sc_data, reduction = \"pca\", pt.size = 0.1, label = F, cols = cols)\n>legend<- get_legend(pca_plot)\n>pca_plot<- pca_plot & NoLegend()\n>ggsave(filename = \"Fig_2_pca_plot.png\", plot = pca_plot, width = 3.75, height = 3.75, dpi = 300)\n>ggsave(filename = \"Fig_2_legend.png\", plot = legend, width = 2, height = 3.75, dpi = 300)",
    "Perform pairwise correlations and hierarchical clustering for these gene sets (top DEGs) across all cells in the scRNA-seq subset, to capture cell-type-specific gene signatures that were assigned to major cell types in CA1 by using previously identified cell markers.\nDefine the correlation plot palette.\nCreate a matrix of 50x10 random values within the range [−1, +1].\n> random.matrix <- matrix(runif(500, min = -1, max = 1), nrow = 50)\nProduce the sample quantiles corresponding to the given probabilities.\n> quantile.range <- quantile(random.matrix, probs = seq(0, 1, 0.01))\nDefine the quantiles where the minimum and maximum correlation values were set to the lowest and highest color. In our case, it was set empirically to 35% and 83% respectively, as these values maximized the contrast for the distribution of values.\n> palette.breaks <- seq(quantile.range[\"35%\"], quantile.range[\"83%\"], 0.06)\nCreate a color ramp that maps the previous interval.\n> color.palette <- colorRampPalette(c(\"#0571b0\",\"#f7f7f7\",\"#ca0020\"))(length(palette.breaks)-1)\nImport the library gplots to access the enhanced heatmap function heatmap.2().\n> library(gplots)\nDefine the hierarchical cluster analysis function, with Pearson correlation coefficient as distance matrix and average as agglomeration method.\n>clustFunction<-function(x)\n    hclust(as.dist(1-cor(t(as.matrix(x)), method = \"pearson\")), method = \"average\")\nDefine the heatmap correlation function, with Pearson correlation coefficient as numeric matrix and the color palette, breaks and clustering function set above.\n>heatmapPearson<- function(correlations)\n              heatmap.2(x = correlations,\n                      col = color.palette,\n                      breaks = palette.breaks,\n                      trace = \"none\", symm = T,\n                      hclustfun = clustFunction)\nCompute the Pearson correlation coefficient on the logarithm of normalized expression of genes from “topDEGs_list” in all cells from scRNA-seq subset.\n> correlations_DEGs_log <- cor(method = \"pearson\",\nlog2(t(as.matrix(sc_data@assays[[\"RNA\"]]@data[topDEGs_list,]))+1))\nGenerate the gene-gene correlation plot and save it to disk.\n> pdf(file = \"Fig_2_corr_plot.pdf\", width = 25, height = 25)\n> heatmapPearson(correlations_DEGs_log)\n> dev.off()",
    "Figure 2[href=https://www.wicell.org#fig2] shows PCA plots and heatmaps of pairwise correlations generated from the 4 lists of top DEGs in our study.\nNote: Points 24 and 25 generate the plots shown in Figure 2[href=https://www.wicell.org#fig2]. Rename the output files in points 24 and 25 to avoid overwriting of the plots when different iterations of Step 4 are performed.\nNote: A R script with the code of this protocol is publicly available at Mendeley Data repository: https://doi.org/10.17632/nkrfxtbrmc[href=https://doi.org/10.17632/nkrfxtbrmc]."
  ],
  "subjectAreas": [
    "Rnaseq",
    "Gene Expression",
    "Neuroscience",
    "Bioinformatics"
  ],
  "bigAreas": [
    "Biomedical & Clinical Research",
    "Molecular Biology & Genetics",
    "Bioinformatics & Computational Biology"
  ]
}