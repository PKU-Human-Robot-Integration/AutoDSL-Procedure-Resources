{
  "id": 4242,
  "origin_website": "Cell",
  "title": "Protocol for using MULTILAYER to reveal molecular tissue substructures from digitized spatial transcriptomes",
  "procedures": [
    "Step-by-step method details\nStep-by-step method details\nHerein we describe Step-by-step methods for analyzing spatial read counts, from the loading of raw data, to its normalization, differential gene expression detection, gene co-expression pattern mapping and finally revealing the spatial communities corresponding to biologically relevant tissue substructures. To illustrate these various steps, we use as an example, the analysis of the Whole Mouse Embryo data generated by Liu and colleagues (Liu et al., 2020[href=https://www.wicell.org#bib2]).\nOpen data on MULTILAYER\nTiming: 10 min\nUse Explore mode for this data. This is used for the analysis of one sample. (Figure 1[href=https://www.wicell.org#fig1]C).\nProvide your dataset by clicking Raw matrix and select the appropriate data; in this case Folder ‘Multilayer-master’, Folder ‘Data’, Folder ‘Whole_mouse_embryo’, File ‘GSM4096262_0725cL.tsv’. (Figure 1[href=https://www.wicell.org#fig1]D).\nNote: A .tsv file (table separated values) should be provided as raw matrix. The correct format is a matrix with gene names as rows, coordinates as columns (coordinates should be in the format ‘XxY’) (see data collection[href=https://www.wicell.org#sec1.5]). It is necessary to enter a raw matrix. Optionally, if you provide your own normalized matrix and / or differential expressed matrix MULTILAYER will use them. If you provide only raw matrix, you can save those generated by MULTILAYER by checking the option for ‘Save Matrix (norm, diff)’.\nSelect option to transpose matrix.\nNote: Transposing the dataset is useful when you have a matrix with gene names as columns and coordinates as rows (see data collection[href=https://www.wicell.org#sec1.5]). When it is not performed (but required), the following error comes up – AttributeError: 'NoneType' object has no attribute 'columns'.\nOptional setting to round off the matrix; default is unchecked.",
    "Note: MULTILAYER requires to round out spatial coordinates for the analysis. For this, the tool needs an integer as X & Y (coordinates) which will get rounded off. For eg: a given coordinate ‘3.36×13.94’ will be converted to ‘3×14’.\nIndicate maximum matrix size or leave as default option 32 × 32.\nClick Next.\nIndicate threshold for up and down regulated differential gene expression; default range is 1 to −1 (in log2).\nIndicate minimum number of contiguous Gexels; default is 10.\nNote: In Pattern detection, the tool uses agglomerative clustering on gexels (https://scikit-learn.org/stable/modules/gen erated/sklearn.cluster.AgglomerativeCluste ring.html[href=https://scikit-learn.org/stable/modules/gen%20erated/sklearn.cluster.AgglomerativeCluste%20ring.html]) to determine a contiguous pattern. It considers a pattern if the number of gexels is equal to or higher than this value. Default value is 10. This value is to be adapted to the size of the tissue, and the resolution of the data (number of total gexels within the matrix). An empirical evaluation of the minimal number of contiguous gexels is required on the basis of the pattern’s detection performance (as illustrated in Figure 10[href=https://www.wicell.org#fig10]).\nIndicate similarity methods- Tanimoto or dice; default is Tanimoto.\nNote: Similarity methods calculate the similarity between patterns.\n- Tanimoto: the similarity is calculated as A Union B / A Intersection B.\n- Dice- the similarity is calculated as 2∗(A Union B) / A Intersection B.\nIndicate multiprocessing i.e., number of threads; default is 1.\nClick next.\nIf the indicated matrix size is inaccurate and/or data is detected in points outside the matrix size suggested, a dialog box will appear indicating a size warning and ask if you want to open the file in a suggested size; here for e.g., 46 × 47. Click yes (go with MULTILAYER’s recommendation) (Figure 3[href=https://www.wicell.org#fig3]A).\nimgsrc:https://prod-shared-star-protocols.s3.amazonaws.com/protocols/998-Fig3.jpg\nFigure 3. Processing whole_mouse_embryo data on MULTILAYER",
    "(A) When the size matrix defined by the user doesn’t comply with the grid size retrieved within the data, a size warning error is displayed. User can decide whether or not to accept the proposed grid size modification. This option does not impact the computing steps, but only the matrix display.\n(B) As MULTILAYER processes the data, the Anaconda prompt interface displays a listing of the different steps taking place.\n(C) Once it is finished, the processed data is available via the MULTILAYER interface.\nThe MULTILAYER interface allows at this stage to access to the various types of processed data (Raw counts, Normalized counts, Gene expression levels, Gene co-expression patterns, gexel communities) (Figures 3[href=https://www.wicell.org#fig3]B and 3C).\nVisualize raw and normalized data on MULTILAYER\nTiming: <10 min\nOn the MULTILAYER interface, select the type of data you want to view (Raw counts, or Normalized counts).\nNote: In contrast to Raw counts, the Normalized matrix provides a view in which all read counts were corrected by using a quantile normalization strategy (as described in (Moehlin et al., 2021[href=https://www.wicell.org#bib3])). Briefly, global read counts normalization is essential to correct technical bias affecting local read count levels across the tissue section of interest. Hence, all downstream steps (differential gene expression, gene co-expression patterns detection, spatial communities’ detection) are issued from the normalized data. In cases in which the user might prefer to use their own normalization strategy, they can upload the normalized and corresponding raw matrix at the beginning of the analysis. In such a situation, MULTILAYER will not apply the quantile normalization correction, but instead it will use the provided normalized data for all downstream steps.\nIn both cases, the Menu button can be used to search for specific genes.",
    "When a gene is selected, users can indicate the minimum or maximum read count threshold to enhance the display; as well as to convert it to log2 (Figure 4[href=https://www.wicell.org#fig4]).\nimgsrc:https://prod-shared-star-protocols.s3.amazonaws.com/protocols/998-Fig4.jpg\nFigure 4. Visualizing a Whole Mouse Embryo data with MULTILAYER\n(A) MULTILAYER interface providing general information, including the dataset sampel ID, matrix size, and the fraction of gexels presenting read counts.\n(B) Raw count matrix displayed when selecting “raw counts” on the MULTILAYER interface. Each read count matrix (raw, Normalized, etc.), is accompanied by a menu bar dedicated to query for genes of interest. Read count levels per gexel are displayed as a heatmap. Hovering over a gexel on the image (indicated by white square and the pointer arrow) gives information of that particular area on the MULTILAYER interface (coordinate, number of counts or level of expression when visualizing the gene expression level matrix). The heatmap refers to the total read counts retrieved per gexel.\nVisualize differential gene expression data on MULTILAYER\nTiming: <10 min\nOn the MULTILAYER interface, select “Gene Expression levels” (Figure 4[href=https://www.wicell.org#fig4]A).\nBy clicking the “Menu” button, a panel displaying a list of the upregulated genes ranked by the number of associated gexels is displayed (Figure 5[href=https://www.wicell.org#fig5]A).\nimgsrc:https://prod-shared-star-protocols.s3.amazonaws.com/protocols/998-Fig5.jpg\nFigure 5. Revealing the differential gene expression within digitized tissue sections",
    "(A) By selecting “Gene Expression levels” on the MULTILAYER interface, users can access a matrix view in which all precomputed differentially expressed genes are ranked on the basis of the number of their associated gexels. A double-click on the gene FABP7, retrieved on the ranked list, allows to visualize the over-expression (in red) or repressed (in green) signature of this gene over the whole tissue. The number at the left side of the Gene name (in this case “108”) indicates the number of gexels within the whole tissue presenting a differential expression for that corresponding gene. The heatmap refers to the differential expression levels (log2) retrieved per gexel.\n(B) when selecting “Gene co-expression patterns” on the MULTILAYER interface, a dialog box appears, allowing to select the minimal number of gexels per gene expression pattern. Like above, users can access a list of ranked genes, this time on the basis of the number of gexels per pattern. A double-click on the gene FABP7 reveals this time a cleaner view relative to (A), in which two distinct patterns (green and blue) complying with the minimal number of gexels per pattern criteria (at least 10) is displayed. For downstream analyses, users have to select a pattern of interest by clicking on one of their associated colored gexels.\nSimilarly, the list of ranked downregulated genes is available by clicking on “Show repressed genes”.\nTo visualize the gene expression location, users can either enter the gene name in the search panel, or double-click on the ranked list.\nTo enhance the display, users can modify the heatmap intervals (within the “threshold panels”), and also modify the differential expression threshold (threshold expression panels).\nVisualize gene co-expression patterns\nTiming: <10 min\nOn the MULTILAYER interface, select “Gene co-expression patterns” (Figure 4[href=https://www.wicell.org#fig4]A).",
    "A dialog box will appear requesting the minimum number of gexels to consider as part of a gene expression pattern (10 gexels by default) (Figure 5[href=https://www.wicell.org#fig5]B).\nNote: The minimum number of contiguous gexels for defining a gene expression pattern depends on the size of the tissue under study, its complexity as well as the resolution of the SrT data.\nAfter clicking on “Run patterns”, a matrix will be displayed. Like in the previous cases, the Menu button displays a panel in which gene patterns are ranked by the number of occupied gexels (Figure 5[href=https://www.wicell.org#fig5]B).\nTo visualize the gene pattern location, users can either enter the gene name in the search panel, or double-click on the ranked list.\nIn some cases, multiple patterns (represented by different colors) can be displayed for a given gene (Figure 5[href=https://www.wicell.org#fig5]B).\nNote: Multiple patterns per gene potentially correspond to biologically relevant events, notably if they are separated by several gexels (excluding a technical discontinuity).\nSelect a pattern by clicking on one of their associated colored gexels.\nSelect the minimal gene co-expression similarity (in percent).\nBy clicking on “similarity”, MULTILAYER will compute spatial gene co-expression signatures for the selected pattern. Gene co-expression is displayed by a spread of gexels from the selected pattern (corresponding to other gexels associated to co-expressed genes), as well as a heatmap corresponding to the gene co-expression similarity; i.e., from red meaning 100% of co-expression similarity (defining the location of the initial gene query), till dark blue corresponding to the least co-expression similarity level. (Figure 6[href=https://www.wicell.org#fig6]A). A comprehensive list of the co-expressed genes and their corresponding similarity with the query gene is displayed within the Powershell prompt console (Figure 6[href=https://www.wicell.org#fig6]B).\nimgsrc:https://prod-shared-star-protocols.s3.amazonaws.com/protocols/998-Fig6.jpg\nFigure 6. A functional analysis of co-expressed genes revealed by MULTILAYER",
    "(A) Gene co-expression analysis for the spatial pattern associated to the gene FABP7. After selecting one of the FABP7 patterns shown in 5b (by clicking on one of the colored gexels associated to the pattern of interest), a gene co-expression similarity (minimal threshold: 10%) is computed. The illustrated matrix, displays gexels occupancy by spatial co-expressed genes with FABP7 (heatmap: similarity level with the query gene).\n(B) A comprehensive list of the identified co-expressed genes is displayed within the PowerShell prompt.\n(C) By clicking on the “Gene Ontology” button in (A), a new dialog panel allows to select for a pertinent GO terms database (here Jensen TISSUES). By pressing the Run button, MULTILAYER assesses the enrichment for the pertinent GO terms and displays their ranking on the basis of their confidence.\n(D) Enriched GO terms associated to the co-expressed genes associated to FABP7 displayed as a Barplot.\nClick on “Gene Ontology” to access a dialog panel to select a GO terms database.\nSelect the adequate GO terms, then press “Run” to access to the Gene Ontology outcome, available either as a Barplot format or a gene vs GO terms heatmap (Figure 6[href=https://www.wicell.org#fig6]C and 6D).\nNote: In case users might require to interrogate a particular GO terms database; users can add the corresponding information to the folder “GO_DB” folder provided together with the MULTILAYER tool. For this purpose, users might adjust their GO terms database of interest to the format associated to the already available collections.\nVisualize spatial communities defining tissue substructures\nTiming: <10 min",
    "While with the “Gene co-expression patterns” function we can query for a gene of interest and visualize the list of other genes that are spatially co-expressed, the “Gexel Communities” function allows to screen for all gene co-expression patterns over the whole tissue, and to then classify them within spatial communities. This is performed as follows:\nWhen selecting “Gexel Communities” on the MULTILAYER interface a dialog box allows users to select the gene co-expression similarity threshold (in percentage), and also the possibility to perform 15 iterative runs and include the gene co-expression similarity levels as a “weight” parameter within the gene regulatory networks used for their spatial communities partitioning (Figure 7[href=https://www.wicell.org#fig7]A).\nimgsrc:https://prod-shared-star-protocols.s3.amazonaws.com/protocols/998-Fig7.jpg\nFigure 7. Revealing spatial tissue substructures by spatial communities partitioning\n(A) Dialog panel defining the minimal gene co-expression similarity to detect gene co-expression Communities. By running this process, a matrix view in which all inferred gene co-expression communities within the tissue section is displayed. Note the presence of a scrolling bar (right side) by which users can access each of the communities.\n(B) When selecting community “1”, the list of the co-expressed genes and their corresponding spatial location is displayed.\n(C) By clicking on Gene Ontology button in (B), a dialog panel allows to select for a pertinent GO terms database (here “Jensen_TISSUES”).\n(D) Barplot display of the enriched GO terms associated to the community “1” displayed in (B).\nNote: Louvain algorithm is performed over multiple iterations (default value: 15 times) and the most frequent outcomes are retained. This can be seen in the PowerShell prompt console.\nBy clicking the “Run Communities” button, MULTILAYER displays a matrix where the spatial communities are highlighted (color-coded gexels) (Figure 7[href=https://www.wicell.org#fig7]A).",
    "Note: When all communities are displayed, it’s possible for communities to overlap. If there are overlaps between communities, the tool will color the gexel as part of the community with the highest similarity.\nBy choosing one community, the over-expressed genes colocalized in that region are listed (Figure 7[href=https://www.wicell.org#fig7]B).\nSimilar to the gene expression analysis described on step 4, by clicking on the “Gene Ontology” button users can access the Gene ontology analysis (Figure 7[href=https://www.wicell.org#fig7]C and 7D).\nNote: A video illustrating the aforementioned steps is available here: https://www.youtube.com/watch?v=zByIdsUyJPg[href=https://www.youtube.com/watch?v=zByIdsUyJPg]\nProcessing high-resolution SrT data\nStep-by-step method of analyzing high resolution data. In this particular case, datasets issued from the technology Slide-seq (Rodriques et al., 2019[href=https://www.wicell.org#bib4]) is used (Hippocampus Brain section). High resolution data are, in general, stored as a three-column format, instead of a gene/coordinate matrix. Prior to MULTILAYER processing, high-resolution files need to be condensed into larger gexels, thus reducing the number of gexels to display, but simultaneously gain on read counts per gexel.\nCompress data with MULTILAYER compressor\nTiming: 10 min\nIn order to compress the file, it is necessary to open the MULTILAYER compressor tool and also indicate the correct directory path to the data.\nIn order to access the compressor tool, type in the PowerShell prompt console:\n> python3 Multilayer_compressor.py -i input.tsv -o output.tsv -cx 60 -cy 60\nor\n> python Multilayer_compressor.py -i input.tsv -o output.tsv -cx 60 -cy 60\nFor e.g.,\n> python Multilayer_compressor.py -i data/high_resolution_brain/Hippocampus_matrix.tsv -o data/high_resolution_brain/Hippocampus_matrix60X.tsv -cx 60\n(Figure 8[href=https://www.wicell.org#fig8]A)\nimgsrc:https://prod-shared-star-protocols.s3.amazonaws.com/protocols/998-Fig8.jpg\nFigure 8. Processing high-resolution hippocampus SrT with MULTILAYER\n(A) The PowerShell prompt console displaying the function to use the MULTILAYER compressor tool. The “-cx” parameter defined to “60”, indicates a compression factor of 60 folds; i.e., the aggregation of proximal gexels such that the size of the matrix is reduced by 60 folds.",
    "(B) High-resolution hippocampus spatial transcriptomics data compressed by a factor of 60×; 100× and 175× respectively and analyzed by MULTILAYER. Display of the spatial expression of the gene PPP3CA for these three compression factors demonstrates a conservation of its spatial signature. The heatmap refers to the total read counts retrieved per gexel.\nNote: The format of the input data has to be in 3 columns, where the first column correspond to barcode coordinates (XxY) with header ‘bc’; the second column to genes with header ‘gene’; and the third column to the gene counts with header ‘count’.\nThe Multilayer_Compressor.py has several arguments: The function -i indicates the input matrix, -o indicates the output matrix, -cx and -cy indicates the compression factor (if -cx and -cy are identical only -cx needs to be defined). By typing\n> python Multilayer_compressor.py -h\ninto the PowerShell console, you get access to the help section of the compressor.\nThe data will be stored in your output directory and can now be opened using the MULTILAYER tool.\nVisualize compressed data on MULTILAYER\nTiming: minutes\nAfter being compressed, datasets can be visualized on MULTILAYER tool as described above in the example of Whole Mouse Embryo (Figure 8[href=https://www.wicell.org#fig8]B).\nNote: A video illustrating the aforementioned steps is available here: https://www.youtube.com/watch?v=ww4x2aP6ENA[href=https://www.youtube.com/watch?v=ww4x2aP6ENA]\nProcessing multiple SrT data at once\nStep-by-step method of using the batch-mode option. To illustrate this module, we have used twelve prostate cancer datasets generated by Berglund et al. (2018)[href=https://www.wicell.org#bib1].\nOpen data on MULTILAYER\nTiming: 10 min\nUse Batch mode for this data (Figure 9[href=https://www.wicell.org#fig9]A).\nimgsrc:https://prod-shared-star-protocols.s3.amazonaws.com/protocols/998-Fig9.jpg\nFigure 9. Use of the “batch-mode” available on MULTILAYER for processing several datasets at once\n(A) MULTILAYER main interface allowing the selection of a folder containing all datasets to process.",
    "(B) Once all datasets are processed (in this case a set of twelve prostate sections), MULTILAYER provides a similar interface than that used for the “explore mode”, giving access to all different analytical panels when one dataset is selected. In addition, a “Comparison datasets” button is displayed.\n(C) This “Comparison datasets” module, allows us to select the samples of interest for processing. Furthermore, it allows us to define the parameters for the spatial community’s detection.\n(D) For selected datasets, users can also define the minimal number of gexels for patterns detection.\n(E) Panel illustrating the classification of all spatial communities detected per analyzed datasets. The interactive panel allows us to visualize the spatial tissue substructure ID and its corresponding class. This information can also be downloaded as a table for further analyses (e.g., graphs display). Furthermore, this panel allows us to access the gene ontology analysis as described for the “explore” mode.\nNote: The Batch mode is useful for analyzing multiple datasets from the same sample.\nProvide your dataset by clicking Raw matrix and select the appropriate folder where all datasets to process are available (in this case the “Prostate Cancer” datasets). All .tsv files in the selected folder will be considered as the input matrix.\nAll values are kept as default values.\nClick next.\nNote: Since multiple files are being processed, this step takes ∼6 min.\nYou are now able to visualize digitally, the raw counts, normalized counts etc. for individual samples as in the example for Whole Mouse Embryo or a comparison dataset for several samples at once on the basis of their associated spatial communities (Figure 9[href=https://www.wicell.org#fig9]B).\nCompare multiple spatial communities on MULTILAYER\nTiming: minutes",
    "On the Multilayer interface, select “comparison datasets” and select all the files to be compared (“Select All” button) or make your own selection (Figure 9[href=https://www.wicell.org#fig9]C).\nDefault values for community’s detection are kept constant for all datasets (weight is checked, multiple iterations (15 times) is checked, threshold is 0%). Furthermore, users can adjust the minimal number of gexels for patterns detection (Figure 9[href=https://www.wicell.org#fig9]D). This option is of major interest in case users have previously identified the minimal number of gexels (Figure 10[href=https://www.wicell.org#fig10]).\nimgsrc:https://prod-shared-star-protocols.s3.amazonaws.com/protocols/998-Fig10.jpg\nFigure 10. Spatial communities revealed over prostate sections as computed with different minimal number of gexels for pattern detection\nThree of the twelve prostate sections analyzed in Figure 9[href=https://www.wicell.org#fig9], are displayed (P3.1, P4.3 and P3.2). When using a minimal number of gexels of 10 (i.e., >9) for pattern detection, several gexels within the tissues are not associated to any of the inferred spatial communities (black-colored gexels; Top panels). By decreasing the minimal number of gexels criteria, it is possible to maximize the number of gexels associated to any of the inferred spatial communities (Bottom panels).\nNote: Users can empirically evaluate the minimal number of contiguous gexels for the analysis, by evaluating the fraction of gexels that are associated to at least one of the inferred spatial communities. As illustrated in Figure 10[href=https://www.wicell.org#fig10], by decreasing the minimal number of gexels from 10 to 5, the spatial communities retrieved within the displayed prostate tissue sections managed to incorporate most of the gexels of the tissue within the inferred patterns.\nRun communities and save the .tsv file.\nNote: When saving the files for the comparison analysis, the tool saves 2 files (ex. save.tsv, save_filter.tsv).",
    "An Interactive heatmap comes up with all the dataset communities. The x-axis represents all the dataset communities, and the y-axis represents all the classes. A class is a group of 1 or several communities. (Figure 9[href=https://www.wicell.org#fig9]E).\nFor gene ontology analysis, click GO terms.\nSelect the number of GO terms and database. In this example, top GO terms =5, database= DisGeNET.\nThis gives a heatmap of the GO terms that can be saved as a plot or matrix (Figure 9[href=https://www.wicell.org#fig9]E)."
  ],
  "subjectAreas": [
    "Bioinformatics",
    "Systems Biology"
  ],
  "bigAreas": [
    "Molecular Biology & Genetics",
    "Bioinformatics & Computational Biology"
  ]
}