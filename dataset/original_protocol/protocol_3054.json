{
  "id": 3232,
  "origin_website": "Cell",
  "title": "3D Quantification of Vascular-Like Structures in z Stack Confocal Images",
  "procedures": [
    "Step-By-Step Method Details\nStep-By-Step Method Details\nCorrect Intensity Attenuation\nTiming: ~30 s per file with Amira\nIn 3D microscopic images, the average intensity in lower slices (i.e., further away from the objective) can be decreased by light absorption in other slices. This intensity attenuation is corrected for using the Correct-Z-Drop module in Amira by fitting an exponential curve to the average intensities in each of the slices. The automatic mode uses with an automatic best fit of a and b, u specifies the slice number scaled between 0 and 1.\nStart Amira and open the converted tiff file (Figure 2[href=https://www.wicell.org#fig2]A). The Project view will open, and an Ortho Slice module will be attached automatically (Figure 2[href=https://www.wicell.org#fig2]B).\nimgsrc:https://prod-shared-star-protocols.s3.amazonaws.com/protocols/280-Fig2.jpg\nFigure 2. Open the Image File in Amira and Correct the Intensity Attenuation\nImport the tiff file into Amira and provide the voxel size (A). The Project view opens automatically, and an Ortho Slice module is attached (B). Attach the Correct Z Drop module by right-clicking on the input data and either use the menu (left) or the search bar (right) (C). Adjust the settings in the properties window (D; lower left field). A new [filename].corrected object is created (E).\nEither use the “Open Data” Button;\nor click on “File” -> “Open Data…” and select the image.\nNote: Here you enter the voxel size as obtained from the image metadata (Figure 1[href=https://www.wicell.org#fig1]).\nAttach the Correct-Z-Drop module by right-clicking on the input data (tiff file) (Figure 2[href=https://www.wicell.org#fig2]C).\nEither using the search box;\nor click on “Image Processing” -> “Grayscale Transforms” -> “Correct Z Drop” and click “Create.”\nClick on the Correct-Z-Drop module to open the Preference view and adjust the settings (Figure 2[href=https://www.wicell.org#fig2]D):\nThe Automatic mode is ticked by default. This can be changed to a user-defined expression if appropriate.",
    "Click on “Apply” to use the module (Figure 2[href=https://www.wicell.org#fig2]E).\nNoise Reduction and Smoothing\nTiming: ~70 s per file with Amira\nBefore applying a threshold to the image to detect the edges of the features, the noise is reduced, and potential artifacts are removed. A median filter is applied to remove the “salt and pepper” noise from the image. This is followed by a Gaussian blur to smooth the boundaries of the features.\nOpen the Console in Amira.\nEither by clicking “Window” -> “Consoles”;\nor by clicking on the console button on the lower right corner of the Amira window;\nor with the shortcut Ctrl + Alt + A.\nType: create “HxlmageFilters” and press the enter key.\nA module called Wrapper: Image Filters will be created in the Project view.\nClick on the Wrapper: Image Filters module to open the Preference view and adjust the settings (Figure 3[href=https://www.wicell.org#fig3]A):\nimgsrc:https://prod-shared-star-protocols.s3.amazonaws.com/protocols/280-Fig3.jpg\nFigure 3. Noise Reduction and Smoothing in Amira\nUse the console to create the Image Filters module (A, lower right panel), select a median filter and adjust the settings (A, lower left panel). Repeat the steps and select a Gaussian smoothing (B).\nSelect the [filename].corrected object as the Data Source.\nFilter: Smoothing: Median; 3D.\nThe Kernel size determines the size of the pixel mask, meaning the area to be sampled when calculating the median. Here, a kernel size of 3, equating to a 3 × 3 × 3 pixel mask in 3D is applied.\nClick on “Apply” and the filtered object will be created in the Project View.\nRepeat step 6 to create a second Wrapper: Image Filters module for the Gaussian blur.\nClick on the Wrapper: Image Filters 2 module to open the Preference view and adjust the settings (Figure 3[href=https://www.wicell.org#fig3]B):\nSelect the [filename]-filtered object as the Data Source.",
    "Filter: Smoothing: Gaussian; 3D.\nA Kernel size of 3 × 3 × 3 is applied for next neighbor detection. The “Sigma Rel” field allows the adjustment of the width of the Gauss function relative to the kernel size. Set the sigma to 1 in x, y, and z and observe the outcome to ensure all key objects are visible without artifacts. Adjust if necessary.\nNote: There are two Consoles in Amira, for Tcl and for Python commands. We used the Tcl Console.\nCritical: For both filters, the kernel size is chosen to cover immediate neighbors. The relative sigma might be adjusted for images with varying noise levels. The outcome can be visualized in Amira by attaching an Ortho Slice module: “Display” -> “Ortho Slice” or by attaching an Image Ortho Projections module: “Display” -> “Image Ortho Projections” to view a 2D projection of the image stack.\nDeconvolution\nTiming: ~180 s per file with Amira\nDeconvolution removes the out-of-focus light present in 3D images. The light diffraction can be characterized by a point spread function (PSF) which is utilized to correct for the distortions and reverse the effects of the out-of-focus light. The PSF can be generated for an experimental set up using a fluorescent bead or created theoretically using known algorithms. We utilize the Amira deconvolution module to compute the PSF and apply a non-blind iterative maximum-likelihood deconvolution algorithm to the data.\nCreate the Deconvolution module by right-clicking on the filtered-filtered object.\nEither using the search box;\nor “Image Processing” -> “Frequency Domain” -> “Deconvolution” and click “Create.”\nClick on the Deconvolution module to open the Preference view and adjust the settings (Figure 4[href=https://www.wicell.org#fig4]A):\nimgsrc:https://prod-shared-star-protocols.s3.amazonaws.com/protocols/280-Fig4.jpg\nFigure 4. Deconvolution Using Amira",
    "Attach the Deconvolution module and adjust the settings in the Properties view (A). After applying the deconvolution algorithm, export the [filename].deconv file as a tiff file (B). The number of iterations effects the outcome of the deconvolution on the y/z axis (C) and the x/y axis (D).\nThe first set of settings determines the parameters for the deconvolution algorithm. To reduce boundary artifacts at the top and bottom (z plane), we chose a border width of 0 in x, 0 in y, and 75 in z with 20 iterations. A constant initial estimate, fixed overrelaxation and no intensity-based regularization and a standard (non-blind) deconvolution method will work for most images. Further information on those settings can be found in the Amira help.\nThe parameters for the point spread function are derived from the numerical aperture of the objective (NA, 0.45), the wavelength of the transmitted light (π, 0.52; an Alexa-488 fluorophore was used in the sample data) and the refractive index of the specimen (n, 1.333; the hydrogel has a similar refractive index as water). The mode was set to confocal. Adjust the settings to be relevant for your image. Alternatively, use the extract point spread function to obtain a point spread function from an imaged bead.\nTwo new objects are created, the point spread function ([filename].psf) and the deconvoluted image ([filename].deconv).\nExport the deconvoluted image by clicking on the [filename].deconv object in the Project view and choose “File” -> “Export Data As.” Change the file type to “3D Tiff (∗.tif)” (Figure 4[href=https://www.wicell.org#fig4]B).",
    "Note: The border width setting reduces potential deconvolution artifacts at the boundaries of the image. For our sample data set, we observed artifacts in z but not in x, and y. For performance reasons, it is advisable to choose the border width such that the sum of the size of the input data set and the border width value results in a power of two. For the example image, the border width in x, y was chosen to be 0 as 0 + 1024 = 1024 equals to 210, and in z equals to .\nThe number of iterations determines the output and is closely linked to the computing time. For our sample data the changes between 5 and 100 iterations were minor (Figures 4[href=https://www.wicell.org#fig4]C and 4D). We selected 20 as a good compromise for improvement versus computing time.\nBinarization\nTiming: ~30 s per file with Fiji\nThe image is binarized in Fiji using the Otsu method. The “Stack” option needs to be ticked in order to process all slices of one stack.\nOpen the deconvoluted tiff image in Fiji (Figure 5[href=https://www.wicell.org#fig5]A).\nimgsrc:https://prod-shared-star-protocols.s3.amazonaws.com/protocols/280-Fig5.jpg\nFigure 5. Binarization of the Image in Fiji\nOpen the deconvoluted images (A) and open the Auto Threshold module (B). Set the properties in the settings window (C) and apply the module. A binarized (black and white) image is the result (D).\nEither use “File” -> “Open” and select the file;\nor drag-and-drop the file into the Fiji window.\nPress “Image” -> “Adjust” -> “Auto Threshold” (Figure 5[href=https://www.wicell.org#fig5]B).\nSelect “Otsu” as the thresholding method and tick the following options: “Ignore black,” “White objects on black background” and “Stack” (Figures 5[href=https://www.wicell.org#fig5]C and 5D).\nSave the binarized image “File” -> “Save as” -> “Tiff….”",
    "Note: In images with a large intensity attenuation, the slices furthest away from the objective might be faint, even after intensity correction. That can lead to noise during binarization. See Troubleshooting 1[href=https://www.wicell.org#troubleshooting]. Use “Image” -> “Stacks” -> “Z Project” to visualize the outcome of the thresholding on a 2D projection. The thresholding method might be adjusted for various images. As an alternative to Fiji, the XImagePAQ extension for Amira includes an Auto Thresholding module which might be used instead.\nLabeling and Removal of Small Fragments\nTiming: ~45 s per file with Amira\nBack in Amira, the multi-thresholding module is used to label the binary image for further processing in Amira. The exterior region is set to 0, so that all voxels with “1” will be labeled as interior.\nTo remove small fragments which are not of interest, the remove island function is applied.\nOpen the binarized image in Amira (see step 1 for details).\nAttach the Multi-Thresholding module by right-clicking on the binarized input object.\nEither using the search box;\nor “Image Segmentation” -> “Multi-Thresholding” and click “Create.”\nClick on the Multi-Thresholding module to open the Preference view and adjust the settings (Figure 6[href=https://www.wicell.org#fig6]A):\nimgsrc:https://prod-shared-star-protocols.s3.amazonaws.com/protocols/280-Fig6.jpg\nFigure 6. Labeling and Removal of Small Fragments in Amira\nThe Multi-Thresholding module is used to label the black (0) pixels as exterior (A). A 3D model can be rendered in the Segmentation View (B). Small particles are removed using the Remove Islands function in Amira (C).\nSet the Exterior-Inside value to 0. Thereby all pixels with value 0 (black) are labeled as exterior. Click “Apply” and a [filename].labels object is created.\nSwitch to the Segmentation view (Figure 6[href=https://www.wicell.org#fig6]B).\nSelect the binarized input image as Image source and the [filename].labels object as Label field.\nSwitch on the two-viewer panel.",
    "Check the box at Inside 3D to view a 3D model of the data.\n“Segmentation” -> “Remove Islands” (Figure 6[href=https://www.wicell.org#fig6]C).\nSelect a size filter (in voxel) in the dialog box. A pictogram explains the neighbor merging function. The “Highlight all islands” button can be used to preview the islands in the Segmentation viewer. Click “Apply” and close the dialog box when finished. For our sample image, we used 159 voxel (600 μm3; 600 μm3/1.23 ×.1.23 × 2.5 μm3/voxel) as a cut-off and merging if the border exceeded 25% of the perimeter, applied to 3D.\nNote: Rendering the 3D model and highlighting islands requires a high-end graphics card and might not be feasible on all machines. Also, the manual removal of fragments in this view is possible.\nThe size of the “islands” has to be provided in voxel.\nDistance Mapping and Thinning\nTiming: ~20 s per file with Amira\nThe distance mapping step labels each pixel with the distances to its boundary pixels to determine the separation of points. The thinner module takes the segmented objects and removes voxel by voxel until a skeleton of connected voxels remains.\nSwitch back to the Projects view and right click on the [filename].labels object and right click to attach a Chamfer Distance map module by:\neither using the search box;\nor “Image Processing” -> “Distance Maps” -> “Chamfer Distance Map” and click “Create.”\nClick on the Chamfer Distance Map module to open the Preference view and adjust the settings (Figure 7[href=https://www.wicell.org#fig7]A):\nimgsrc:https://prod-shared-star-protocols.s3.amazonaws.com/protocols/280-Fig7.jpg\nFigure 7. Distance Mapping and Thinning in Amira\nUse a Chamfer Distance Map module (A) and a Thinner module (B) to skeletonize the image.\nSet the interpretation to XY planes.\nSelect the labels object and right click to attach a Thinner module by:\neither using the search box;",
    "or “Image Processing” -> “Skeletonization” -> “Thinner” and click “Create.”\nClick on the Thinner module to open the Preference view and adjust the settings (Figure 7[href=https://www.wicell.org#fig7]B):\nSelect the [filename].labels object as data source and the [filename].distmap object as Distmap source.\nThe len of ends parameter (extended options) controls the length of unconnected ends (in voxel) and thereby control’s the sensitivity to generate branch points. Select a size according to your data set and the structures of interest. For the sample data, we applied a size of 5 voxel.\nClick on “Apply” and a [filename].thinned object is created.\nNote: The Chamfer Distance Map module can process the image slice by slice (Interpretation: XY planes) or as a whole in 3D (Interpretation: 3D) depending on the application. For our data set, we used the XY interpretation due to the higher resolution in the x/y plane.\nConvert to Spatial Graph and Compute Thickness\nTiming: ~30 s per file with Amira\nThe Trace Lines module converts the thinned image into a Spatial Graph object in which the data is organized as a graph. Branch or endpoints are represented by the vertices of the graph (Nodes) which are connected by curved lines (Segments). This Spatial Graph is then smoothed using a Smooth Line Set module. The Eval on Lines module connects to smoothed skeleton and the distance map to compute the thickness information of the skeleton.\nSelect the [filename].thinned object and right click to create a Trace Lines module by:\nEither using the search box;\nor “Image Processing” -> “Skeletonization” -> “Trace Lines” and click “Create.”\nClick on the Trace Lines module to open the Preference view and adjust the settings (Figure 8[href=https://www.wicell.org#fig8]A):\nimgsrc:https://prod-shared-star-protocols.s3.amazonaws.com/protocols/280-Fig8.jpg\nFigure 8. Convert to Spatial Graph and Compute Thickness in Amira",
    "Attach a Trace Lines module to convert the thinned image into a Spatial Graph object (A) and use the Smooth Line set module (B). Calculate the thickness information with the Eval on Lines module (C) and export the spatial graph object as an .mv3d file (D).\nTick “lineset” and “point cloud” to compute lines (vessels) and points (branch- and endpoints).\nClick on “Apply” and a [filename].Spatial-Graph object is created.\nSelect the [filename].Spatial-Graph object and right click to create a Smooth Line Set module by:\nEither using the search box;\nor “Compute” -> “Smooth Line Set” and click “Create.”\nClick on the Smooth Line Set module to open the Preference view and adjust the settings (Figure 8[href=https://www.wicell.org#fig8]B):\nThe smoothing coefficient controls the effect of adjacent points on the position of a point. Adhere to original data controls the effect of the initial position. For our sample data set we set a smoothing of 0.5 and adhere to data of 0.25.\nClick on “Apply” and a “SmoothTree.Spatialgraph” object is created.\nSelect the “SmoothTree.Spatialgraph” object and right click to attach an Eval on Lines module by:\nEither using the search box;\nor “Compute” -> “Eval on Lines.”\nClick on the Eval on Lines module to open the Preference view and adjust the settings (Figure 8[href=https://www.wicell.org#fig8]C):\nData Source: SmoothTree.Spatialgraph.\nField: [fielname].distmap object.\nClick “Apply.”\nSelect the SmoothTree.Spatialgraph. Export the data “File” -> “Export Data as” and change the file type to microvisu3D ASCII (.mv3D) (Figure 8[href=https://www.wicell.org#fig8]D).\nThe mv3d file is a text file containing points specified by a x, y and z coordinate, and number (the ID of the segment this point belongs to).\nOptional: Go to the Filament View to view the output of the Spatial Graph object.\nMeasurements\nTiming: ~30 s per file with WinFiber3D",
    "WinFiber3D is used to visualize the spatial graph data and to export the measurements (Figure 9[href=https://www.wicell.org#fig9]).\nimgsrc:https://prod-shared-star-protocols.s3.amazonaws.com/protocols/280-Fig9.jpg\nFigure 9. The WinFiber3D Workspace (Left Side) and the Save File Dialog (Right Side)\nOpen WinFiber3D and open the mv3D file by\neither “File” -> “Open”;\nor Ctrl + O.\nExport the measurements\neither “File” -> “Save”;\nor Ctrl + S.\nThe output file is saved as a tab delimited text file. However, the file extension (.txt) needs to be provided with the file name.\nTick “Statistics” to save the measurements of the complete network.\nTick “Segment data” to save the orientation data, length, and average diameter of each segment.\nTick “Vessel data” to export the length, volume, and branch points information for each vessel.\nOptional: Loops, segments which start and stop at the same point, can be removed with “Tools” -> “Delete Loops.” The boxes on the right-hand side present the overall statistics as well as properties of a selected structure. Structures can be removed manually by selecting them with the mouse and click on “Delete”. Various options for rendering the network are available below the selection box."
  ],
  "subjectAreas": [
    "Cell Culture",
    "Tissue Engineering",
    "Microscopy"
  ],
  "bigAreas": [
    "Biomedical & Clinical Research",
    "Bioengineering & Technology"
  ]
}