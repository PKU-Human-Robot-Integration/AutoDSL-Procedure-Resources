{
  "id": 1818,
  "origin_website": "Cell",
  "title": "MATISSE: An analysis protocol for combining imaging mass cytometry with fluorescence microscopy to generate single-cell data",
  "procedures": [
    "Step-by-step method details\nStep-by-step method details\nTissue staining\nTiming: 2 days (day 1: 4 h, day 2: 3 h)\nIn this step, tissue sections are prepared, stained with isotope-labeled antibodies, as well as metal-based (Iridium) and fluorescent (DAPI) DNA intercalators.\nDay 1\nPlace FFPE tissue sections in a slide rack.\nDewax tissue sections in xylene for 2 × 10 min in containers in the fume hood.\nIn the meanwhile, heat up a water bath to 96°C.\nRehydrate tissue sections in descending grades of ethanol in containers in the fume hood:\n100% ethanol, 10 min\n95% ethanol, 5 min\n80% ethanol, 5 min\n70% ethanol, 5 min\nMQ, 3 min\nPlace the rack with tissue sections in a container with TBST for 10 min in order to wash the slides.\nIn the meantime: fill #number∗50 mL Falcon tubes with Tris-EDTA antigen retrieval buffer (∼35 mL per tube) and preheat in the water bath to 96°C.\nInsert the tissue sections into the 50 mL tube with preheated Tris-EDTA buffer and incubate at 96°C for 30 min in the water bath.\nNote: Two tissue sections fit back-to-back in a 50 mL tube.\nTake the tubes containing Tris-EDTA buffer and the tissue sections from the water bath and cool down on a lab bench for approximately 5–10 min.\nPlace the tissue sections back in a rack and wash with TBST for 10 min in a container.\nDry the back of the glass slide with a paper tissue, and the glass surrounding the tissue with an aspirator pump.\nCircle the tissue with hydrophobic peroxidase-antiperoxidase (PAP) pen. Keep a 1–2 mm distance between tissue and PAP barrier.\nNote: Make sure the PAP barrier is properly closed so no fluid can leak or spill over to other tissues on the glass slide (Figure 3[href=https://www.wicell.org#fig3]A).\nimgsrc:https://prod-shared-star-protocols.s3.amazonaws.com/protocols/1297-Fig3.jpg",
    "Figure 3. Antibody incubation\n(A) Correct and incorrect example of surrounded tissue by PAP. The incorrect example shows spillover of fluid between different tissue samples on the same glass slide. Additionally, leakage of fluid can also happen when tissues are correctly surrounded by PAP. This can be prevented by decreasing the buffer volume.\n(B) Humidified staining tray containing tissue sections incubating with blocking buffer.\nPut the slides in a staining tray (with lid) and pipette 100 μL blocking solution on the tissue. Incubate 60 min at 18°C–22°C.\nNote: Wet paper towels with demi water and add to the staining tray to ensure a humidified environment (Figure 3[href=https://www.wicell.org#fig3]B).\nCarefully remove the blocking solution from the tissue using an aspirator pump (Methods video S1[href=https://www.wicell.org#mmc1]).\nAdd 100 μL antibody cocktail (Table 1[href=https://www.wicell.org#tbl1]) to the tissues and incubate for 16–20 h at 4°C in the humidified staining tray with a closed lid.\ntable:files/protocols_protocol_1297_9.csv\nStore at 4°C for a maximum of 24 h.\n    Your browser does not support HTML5 video.\n  \nMethods video S1. Removing blocking solution from the slide using vacuum (step 11)\nDay 2\nCarefully remove the staining solution from the slide using an aspirator pump.\nPlace the slides in a rack and wash 3 × 5 min in TBST in a container on a shaking plate at 50–100 RPM.\nDry the back of the glass slide, and the glass surrounding the tissue with paper towels and place the tissue sections in the staining tray.\nPipette 100 μL of DNA intercalator mix on the tissue. Incubate for 60 min at 18°C–22°C.\nCarefully remove the DNA intercalator mix from the slide using an aspirator pump.\nPlace the tissue sections in a rack and wash in MQ for 3 min in a container.",
    "Remove the slides from the rack, and carefully remove excess liquid with a paper towel and aspirator pump.\nAir dry the slides for at least 20 min at 18°C–22°C.\nPause point: Stained tissue sections can be stored at 4°C in the dark until time of DAPI imaging. It is recommended to not store the stained tissue sections longer than 6 weeks before DAPI imaging due to potential fading of the DAPI signal over time.\nFluorescent imaging\nTiming: 6–10 h\nIn this step, tile-region scans are obtained of the DAPI staining using a fluorescent microscope. Focus points and Z-stacks are used to ensure that all parts of the scanned tissue are captured in focus. Depending on the size of the scan, obtaining 2 tile-regions of 5 different tissue biopsies (located on 5 different glass slides) takes approximately 6 h (4 mm2 per tissue, 20× scan) to 10 h (25 mm2 per tissue, 20× scan) including settings.\nNote: Decide on which tissue regions you want to acquire data on. After IMC ablation, fluorescent images can no longer be obtained. Always make a DAPI tile-region scan bigger in size than the region of interest for ablation by IMC as indicated in Figure 2[href=https://www.wicell.org#fig2].\nCRUCIAL: Use a dry objective for imaging since the tissue sections are not mounted with a cover slip.\nStart the fluorescent microscope and Zen 2.6 Blue edition software.\nSelect the correct settings as illustrated in Figure 4[href=https://www.wicell.org#fig4].\nimgsrc:https://prod-shared-star-protocols.s3.amazonaws.com/protocols/1297-Fig4.jpg\nFigure 4. Tile-region scanning settings Zeiss Z1 imager\nIn the acquisition tab, enable “Z-stack” and “Tiles”. Enable “Autosave” in order to automatically save all (raw) files to a specific location.\nSelect the channels tab and select DAPI.\nMake sure binning is set to 1 × 1, and detector bit-depth is set to maximum value.",
    "In the Multidimensional Acquisition window (Figure 4[href=https://www.wicell.org#fig4]), select the Tiles tab. Now select the options drop-down and set the “tile overlap” at 10 percent and the “travel in tile regions” on Meander.\nNote: Other “travel in tile regions” methods can be used but will not be recognized by default in the scripts included in the MATISSE pipeline.\nSet the focus and exposure time at 5× magnification. In general, the DAPI exposure time is between 5 and 250 ms.\nNote: Do not use auto exposure during tile-region scanning. All images should be acquired using identical exposure settings.\nCalibrate the X/Y position of your glass slide.\nFrom the tiles menu, select advanced setup.\nLocate the frosty end (top left for upright microscope systems) of the glass slide using binocular vision.\nIn the sample carrier drop-down menu, select slide 25 × 75 mm.\nClick on calibrate in the sample carrier drop-down menu. Move the lighting path from binocular to the camera. In the step 1/3 window, click next (located at the left bottom of the window). In the step 2/3 window choose “set Zero” and click on next. In the step 3/3 window choose “set current X/Y” and click finish. The stage is now calibrated to the inserted microscopy slide which allows easy orientation and mapping of the tissue (Figure 5[href=https://www.wicell.org#fig5]).\nimgsrc:https://prod-shared-star-protocols.s3.amazonaws.com/protocols/1297-Fig5.jpg\nFigure 5. Generating tile-region scan\nTile settings used on the Zeiss Z1 imager for scanning tile-regions. (1) Starting position of the cursor after X/Y position calibration. (2) Selection of a region on the glass slide for preview scanning. (3) Selection of a region of interest for 20× scanning on the preview scan.\nMake a preview DAPI scan at 5× magnification.",
    "In the tile region set-up (located at the bottom of the screen), select setup by “Contour” (Figure 5[href=https://www.wicell.org#fig5]). Select the rectangle tool.\nDraw a region on the screen of the region of interest for preview scanning (Figure 5[href=https://www.wicell.org#fig5]). Alternatively, make a preview of the full slide.\nSet the focus for the camera using the “live” mode.\nGo to the “Preview Scan” tab and hit the “Start Preview Scan” button. Now the microscope will start to generate the slide preview.\nMake a detailed 20× DAPI scan.\nSwitch the microscope objective to a dry 20× objective\nSet the exposure time for DAPI at 20× (∼5–50 ms).\nDraw the region of interest for 20× scanning on the preview scan (Figure 5[href=https://www.wicell.org#fig5]) by using the rectangle tool in the “Contour” tab.\nIn the Tiles tab, go to the “Tile regions” drop-down menu and deselect the Tile region that represents the generated preview scan (Figure 6[href=https://www.wicell.org#fig6]A).\nimgsrc:https://prod-shared-star-protocols.s3.amazonaws.com/protocols/1297-Fig6.jpg\nFigure 6. Setting focus points\n(A and B) Settings used on the Zeiss Z1 imager for (A) adding focus points to tile scans, and (B) setting Z-stacks.\n(C) Representative image of a selected region of interest for 20× scanning projected on the preview scan. The yellow circles indicate the set focus points.\n(D) Pop-up window for verification of tile regions/positions.\nSelect the newly created tile region and rename to the desired region name.\nCritical: Naming your files correctly and consistently is extremely important Please carefully read the Folder naming and structure paragraph[href=https://www.wicell.org#sec1.1] of this protocol before naming your regions and files for data acquisition.\nIn the Multidimensional Acquisition window, select the Z-Stack tab. In the Z-Stack tab, select the “Center” option. Additionally, set the number of slices to 9–12 and the interval to 1.5 μm (Figure 6[href=https://www.wicell.org#fig6]B). Making Z-stacks ensures that the entire tile-scan is in focus.",
    "Add focus points to the tile region to correct for focus drift. Distribute focus points evenly over the tile region (Figure 6[href=https://www.wicell.org#fig6]C).\nIn the tiles tab, select “focus surface (verify)” in the drop-down menu. Add focus points throughout the panorama by clicking the “+” in the local (per tile region) box.\nClick on “verify tile regions/positions” in the “local (per tile region)” box. A window will appear listing all focus points. Select the first focus point and click “move to current point”. Turn on ‘live’ mode. Adjust the focus of the current focus point and click on “Set Z & Move to Next” (Figure 6[href=https://www.wicell.org#fig6]D). Do so for all focus points. Close the window when all points are verified.\nNote: A 20× scan of 2000 × 2000 μm takes approximately 10 minutes.\nWhen additional regions need to be scanned on the same glass slide, repeat steps 25 and 26.\nIn the Acquisition tab, click on “Start Experiment”.\nSave the czi file. Before naming the file, please carefully read the Folder naming and structure paragraph[href=https://www.wicell.org#sec1.1] of this protocol.\nImage export\nClick on the processing tab in the left upper corner. Select the option “Batch”\nSelect “Image export” in the “Batch method” drop-down window.\nSelect export parameters as illustrated in Figure 7[href=https://www.wicell.org#fig7]. Importantly, export all files in tiff format without compression and generate a .xml file.\nimgsrc:https://prod-shared-star-protocols.s3.amazonaws.com/protocols/1297-Fig7.jpg\nFigure 7. Export settings Zeiss Z1 imager\nAdd all .czi files containing the tile region images to the file que in the “Batch processing” window via the “+ Add” button.\nChoose the saving location. Deselect “Use input Folder as output folder”, click on “…”, and navigate to the folder in which the images should be stored.\nClick on Apply in the processing tab.",
    "Store the exported folder with DAPI .tiff files locally on your computer in a folder called “FLUOR_data”.\nNote: Every .czi file results in export of one folder with DAPI .tiff files with the same name as the czi file (i.e. S1_T20 for the example illustrated in the Folder naming and structure paragraph[href=https://www.wicell.org#sec1.1] of this protocol). This exported folder can contain DAPI .tiff files from multiple tile regions (i.e. S1_T20_R1 and S1_T20_R2).\nStitching DAPI panorama\nTiming: 8 h\nIn this step, the exported tile-regions are stitched using Fiji scripts. First, single-image .tiff exported from the Zen software are concatenated into multi-image stacks to recreate the original Z-stack. Then, all stacks are converted to single in-focus images by the extended depth of field (EDF) principle. Finally, all EDF-projected images are stitched using the MIST plugin to create a full seamless panorama of the original tile-region.\nThe scripts expect a specific folder structure. The images from the different processing steps are stored in the following folders: “Stacks”, “EDF”, and “Stitch”. In total, the processing of 10 DAPI tile regions (2 tile regions of 5 tissue biopsies) consisting of 60 tiles takes approximately 8 h on a recommended workstation.\nNote: Make sure to have the exported “_info.xml” file present next to the exported .tiff files (this file should be exported by the Zen software in the same folder as the .tiff files)\nNote: When running Fiji steps, do not interfere with your computer.\nFolder structure:\n/FLUOR_data\n  /S1_T20\n    /+Stacks\n      /+EDF\n/+Stitch\nConcatenate single-image .tiff files to multi-image stacks.\nOpen script Fluorescence_StackGeneration2.ijm in Fiji (by dragging it into Fiji) and press run.\nIn the pop-up window, select the folder with all exported .tiff files from the panorama (S1_T20 folder in example) and click open.\nThe script will now process and store all acquired image stacks.",
    "The script is finished when the log screen prints “DONE”. A “Stack” folder is now created containing stacked .tiff files. Troubleshooting 1[href=https://www.wicell.org#troubleshooting]\nConvert stacks to single-plane images.\nOpen script Fluorescence_ExtendedDepthOfField.ijm in Fiji (by dragging it into Fiji) and press run.\nIn the pop-up window, select the FLUOR_data folder and click open.\nRunning the script takes a while (approximately 30 min for 60 tile regions using npar = 3 settings. It will take a maximum of 15 min when using npar = 6 settings). The script is finished when the pop-up window “Processing completed!” appears. An “EDF” folder is now created with .tiff images.\nCreate a seamless panorama by stitching all EDF-projected stacks.\nOpen script Fluorescence_TileRegionStitchName_ToSubfolder.ijm in Fiji (by dragging it into Fiji) and press run.\nIn the pop-up window, select the folder that contains your exported .tiff files (S1_T20 folder in example) and click open.\nThe script is finished when the log screen prints “DONE”. A “Stitch” folder is now created. This folder contains your stitched panorama.\nNote: Consider deleting the raw microcopy files when all tile-regions are correctly stitched in order to save storing space on your computer.\nIMC ablation and export\nTiming: 7 h\nIn this step, IMC is used to ablate a tissue region from the prepared tissue section. It takes approximately 1 h for machine warm-up, and tuning. Ablating 2 regions (500 × 500 μm) of 5 tissue sections (located on different glass slides) takes approximately 8.5 h.\nAblate tissue regions from the stained tissue sections using the Hyperion according to the standard Fluidigm IMC protocol.\nName the regions (ROI) according to your naming scheme.\nSave the mcd file.\nNote: The ablated tissue area must be part of the prepared DAPI panorama (Figure 2[href=https://www.wicell.org#fig2]).",
    "Export the ablated regions of interest from .mcd files using Python and imctools.\nOpen Anaconda and launch Spyder.\nRun the mcd_to_ometiff.py script.\nIndicate the path of the input folder in line 79.\nIndicate the path of the output folder in line 80.\nome.tiff files are now stored in the indicated output folder.\nAlternatives: Run the script in step 37 in PyCharm.\nExtract IMC channel names.\nOpen an ome.tiff file in Fiji and run script OME-tiff-channelnames_imctools2.ijm. This script will give you an overview of the different IMC channel names present in the file. This list is required during downstream analysis.\nRename the ome.tiff files according to the given ROI names during IMC acquisition.\nOpen script OME-renamer.ijm in Fiji and press run.\nIn the pop-up window, select the folder with extracted ome.tiff files from step 37 and click open.\nThe ome.tiff files exported in step 37 are now renamed according to the given ROI names during IMC acquisition.\nStore the renamed stacked 32-bit .tiff files locally on your computer in a folder called “OMETIF”. Place the OMETIF folder in a folder called “IMC_data”.\nPause point: At this point in the protocol, all experimental data is acquired. Data processing steps are not time critical and can be paused/continued at every desired moment.\nImage registration\nTiming: 3 h",
    "In this step, the DAPI panorama is aligned with the Ir193 IMC images. First of all, the single Ir193 .tiff files are extracted from the combined 32-bit .tiff stacks that were created in step 39. Then, Fiji is used to align the DAPI panorama with the Ir193 IMC images using the SIFT and Landmark correspondence plugins. The “Ir193” and “Registration” folders are generated while running the scripts. The “FileList.csv file” is created manually while following the image registration steps. Image registration of 10 images takes approximately 3 h.\nFolder structure:\n/FLUOR_data\n  /S1_T20\n    /Stacks\n      /EDF\n  /+Registration\n    /+Keypoints\n    /+Overlay\n  /+FileList.csv file\n/Stitch\n/IMC_data\n  /OMETIF\n  /+Ir193\nDetermine the correct brightness and contrast for the DNA-Ir193 IMC channel.\nOpen the combined 32-bit .ome.tiff IMC images in Fiji. Scroll through the stack and identify the Ir193 channel (see step 38). Write down the number of this channel.\nOpen the Brightness/Contrast window using Image >> Adjust >> Brightness/Contrast. Set the minimum display brightness to 0. Drag the “maximum” down until the signal is saturated (can be checked by clicking LUT >> HiLo, red indicates saturated signal). Some pixels should show saturation, but not all. Identify the maximum intensity threshold in the Brightness/Contrast window and write down this threshold.\nCRUCIAL: Setting the correct brightness/contrast is crucial for further analyses. Examples of incorrect and correct settings are illustrated in Figure 8[href=https://www.wicell.org#fig8]. Use identical brightness/contrast settings for multiple regions obtained during the same staining procedure and IMC run.\nimgsrc:https://prod-shared-star-protocols.s3.amazonaws.com/protocols/1297-Fig8.jpg\nFigure 8. Brightness and contrast settings for IMC images",
    "Examples are shown of correct and incorrect brightness and contrast settings of Ir193 IMC images. The original Ir193 images are shown, as well as images with HiLo display settings (blue: low-end saturated pixels; red: high-end saturated pixels). The brightness/contrast window indicates the used threshold for each image. Scale bar indicates 200 μm.\nExtract DNA-Ir193 images from the stacked 32-bit .ome.tiff IMC files.\nOpen the OME_ExtractChannel2.ijm script in Fiji (by dragging it into Fiji).\nIndicate the channel number of the Ir193 channel in line 2.\nIndicate the correct max intensity threshold for the Ir193 channel in line 4.\nRun the script.\nIn the first pop-up window, select the OMETIF folder.\nIn the second pop-up window, select the IMC_data folder.\nThe script is finished when the pop-up window “done” appears. An “Ir193” folder is now created in the IMC_data folder. This folder contains the single Ir193 .tiff files.\nCreate a table in a comma-separated file (.csv file) where the DAPI and Ir193 images of the same regions are linked as illustrated in Figure 9[href=https://www.wicell.org#fig9]A. The content of the file should be as follows:\nimgsrc:https://prod-shared-star-protocols.s3.amazonaws.com/protocols/1297-Fig9.jpg\nFigure 9. DAPI and Ir193 image registration\n(A) Example of the table (.csv file) for image matching and subsequent registration.\n(B) Overlay (right) of DAPI (left image) and Ir193 (center image) images after registration. Blue: DAPI; Red: Ir193. Scale bar indicates 200 μm.\nColumn 1: [Path to FLUOR Stitch folder]\nColumn 2: [Path to IMC Ir193 folder]\nColumn 3: [Name of the region = output name]\nNote: A header for the columns can be included in the first row of the .csv file (for instance: FLUOR, IMC, Name as indicated in Figure 9[href=https://www.wicell.org#fig9]A).\nSave the file as “FileList.csv” in the FLUOR_data folder.\nRegister the DAPI and IMC images:",
    "Open the script: Fluorescence_Registration_FileList.ijm in Fiji (by dragging it into Fiji) and click on run.\nNote: Adapt the scale parameter in the script (lines 18–20) to 1/pixel size for the used microscope settings. Default parameters are suggested for the Zeiss Z1 imager for a 20× objective.\nSelect the FLUOR_data folder. The script will start running now. This takes approximately 1–3 min per image.\nThe script is finished when the pop-up window “done” appears. The script will generate a “Registration” folder, as well as “Keypoints” and “Overlay” folders.\nIn the Registration folder, the cropped and registered DAPI images are saved.\nIn the Overlay folder, a registered overlay image is saved.\nCheck the overlay images located in the Overlay folder. If the DAPI images and Ir193 IMC images are properly overlayed, the image shows an overlay of blue (DAPI) and red (Ir193) colors, together creating magenta color. An example is illustrated in Figure 9[href=https://www.wicell.org#fig9]B. Troubleshooting 2[href=https://www.wicell.org#troubleshooting]\nSelect subset of data for training and validation\nTiming: 2 h\nIn this step, data is extracted for training purposes. We suggest using 10% surface area of every obtained image for training purposes. In order to keep the 10% selection of every image as unbiased as possible, random crop regions are obtained from the DAPI images and IMC channels in this step. One 10% crop region will be used for training purposes, the other 10% crop region will be used for validation of the training in the next step. The “MachineLearning”, “Training”, and “Validation” folders are generated while running the scripts, as well as the “SubsetROICoords.txt” file. Selecting data subsets from 10 images takes approximately 2 h.\nFolder structure:\n/FLUOR_data\n  /S1_T20\n    /Stacks\n      /EDF\n  /Registration\n    /Keypoints\n    /Overlay\n  /FileList.csv file\n/Stitch\n  /+Training\n  /+Validation\n  /+SubsetROICoords.txt\n/IMC_data\n  /OMETIF\n  /Ir193\n  /+MachineLearning\n    /+Training\n    /+Validation",
    "Extract training and validation data from the DAPI images.\nOpen an aligned DAPI image in Fiji.\nOpen the script: RandomImageCrop2.ijm in Fiji (by dragging it into Fiji) and press run.\nNote: Adapt the scale parameter in the script (lines 7–9) to 1/pixel size for the used microscope settings. Default parameters are suggested for the Zeiss Z1 imager for a 20× objective.\nIn the pop-up window, select the size of the crops you would like to make in micrometers. The default setting is 158 × 158 μm (10% of a 500 × 500 μm image). Click “OK”.\nTwo proposed crop regions are shown on the DAPI image (Figure 10[href=https://www.wicell.org#fig10]A). A pop-up window will appear with the question whether you are satisfied with the suggested regions. If yes, click “OK”.\nimgsrc:https://prod-shared-star-protocols.s3.amazonaws.com/protocols/1297-Fig10.jpg\nFigure 10. Generation of training and validation subsets\nTraining and validation subsets are generated from the original fluorescent and IMC data.\n(A) Two random crops consisting of 10% of the total tissue area are suggested within the original DAPI image. Scale bar indicates 50 μm.\n(B) IMC image stacks are cropped with identical coordinates as defined in the DAPI images in (A). Scale bars indicate 25 μm.\nIf you are not satisfied with the suggested regions (for instance because they are located outside the tissue area), deselect “satisfied” and click “OK”. New crop regions will be suggested.\nIn the end, two non-overlapping regions per image will be generated. One image will be stored in a folder called “Training”. The other image will be stored in a folder called “Validation”.\nSelect IMC channels:",
    "Open the stacked 32-bit .tiff IMC images (located in the OMETIF folder) in Fiji. Scroll through the stack and identify + note down the numbers of the channels you would like to include for downstream analyses (use the table generated in step 38). In the example illustrated in this protocol, all markers included in the antibody cocktail (Table 1) were included for downstream analyses.\nNote: The order of the chosen channels is important to write down, since this information is not visible when opening the .tiff stack in Ilastik.\nDetermine the correct maximum intensity thresholds for the chosen channels as explained in step 40. These thresholds should work for all images inside the dataset.\nOpen the script: OME_ExtractMachineLearningStack2.ijm in Fiji (by dragging it into Fiji).\nIndicate in line 1 the numbers of the channels you would like to include for membrane training.\nIndicate in line 2 the maximum intensity thresholds per channel.\nRun the script.\nIn the first pop-up window, select the OMETIF folder with 32-bit ome.tiff IMC files.\nIn the second pop-up window, select the IMC_data folder.\nThe script is finished when the pop-up window “done” appears. A “MachineLearning” folder is now created in the IMC_data folder. This folder contains the multichannel IMC images of the indicated channels.\nExtract training and validation data of the IMC images.\nOpen script RandomImageCrop_ApplyToOthers2.ijm in Fiji and press run.\nIn the pop-up window, select the “MachineLearning” folder that contains the stacked IMC images and click open.\nIn the second pop-up window, select the “SubsetROICoords.txt” file generated with the script in step 46 and click open.\nThe stacked IMC images are now cropped with identical coordinates as the fluorescent images as illustrated in Figure 10[href=https://www.wicell.org#fig10]B and stored in the created “Training” and “Validation” folders within the MachineLearning folder.\nDAPI probability maps\nTiming: 1 day",
    "In this step, probability maps are generated based on the DAPI images. First, manual nucleus annotations are generated in Fiji. Next, a data enrichment step is performed in Fiji using the FeatureJ, MorphoLibJ plugins. Finally, these manual annotations and the enriched images are used for training machine learning in Ilastik software. A validation step is included in order to verify whether the training is sufficient. The “Annotations”, “Morph-Feat”, and “ProbabilityMaps” folders are generated while running the scripts. Generating DAPI probability maps for 10 158 × 158 μm training images takes approximately 7 h.\nFolder structure:\n/FLUOR_data\n  /S1_T20\n    /Stacks\n      /EDF\n  /Registration\n    /Keypoints\n    /Overlay\n  /FileList.csv file\n/Stitch\n  /Training\n    /+Annotations\n      /+Mask\n      /+Overlay\n    /+Morph-Feat\n  /Validation\n    /+Morph-Feat\n  /SubsetROICoords.txt\n  /+Morph-Feat\nGenerating nucleus annotations data:\nOpen a single DAPI .tiff image from the Training folder in Fiji and then open the MannualAnnotation_Training.ijm script Fiji (by dragging it into Fiji) and click on run.\nChoose “Nuclei” in the pop-up screen.\nZoom in and annotate nuclei using the brush tool (or another selection tool). Make sure to color the entire surface area of a nucleus, up to the nuclear border. Press B to store the drawn annotation. Click on “oke” when finished. Figure 11[href=https://www.wicell.org#fig11] shows annotation examples.\nimgsrc:https://prod-shared-star-protocols.s3.amazonaws.com/protocols/1297-Fig11.jpg\nFigure 11. Manual annotations\nNuclei (red) and background (green) are manually annotated in the training images. Scale bar indicates 20 μm.\nNote: Annotate nuclei with distinguishable nuclear borders. Hence, only annotate the nuclei you are confident about.\nNote: It is recommended that different people annotate nuclei for training in order to obtain reliable training data.\nNow annotate background pixels by selecting “Background” in the pop-up screen.",
    "Select the areas in the images without nuclei using the brush tool (or another selection tool). Also draw closely around annotated nuclei. Press B to store the drawn annotation. Click on “OK” when finished with making annotations. Figure 11[href=https://www.wicell.org#fig11] shows examples of annotated background pixels.\nClick on “save” when you are finished with all annotations. This will store your annotations in the “Annotations” folder.\nData enrichment:\nOpen the FilterAdditionStack.ijm script in Fiji and press run. This script will result in data enrichment which will be used in the next step to generate DAPI prediction maps. In total, this script needs to be run 3 times: (1) for the training dataset, (2) the validation dataset, and (3) the actual dataset. Generated image features and 2D segmentation images are stored in the “Morph-Feat” folders.\nRun 1: In the pop-up window, select the Training folder.\nRun 2: In the pop-up window, select the Validation folder.\nRun 3: In the pop-up window, select the Stitch folder.\nNote: From this point onwards, the steps in the MATISSE pipeline do not depend on folder structure anymore.\nGenerate DAPI prediction maps on training images:\nStart the Ilastik software and select the pixel classification workflow.\nIn the Input Data tab, add the images from the Morph-Feat folder inside the training folder.\nSelect all the added files and right click. Click on “Edit shared properties” and change storage from “relative link” to “copy into project file”. Click on OK.\nIn the Feature Selection tab, click on “Select Features”. Select all features with sigma 1. Click on OK.\nProceed to the Training tab and add 1 label to the already present labels, 3 in total.",
    "In the “Current View” box, select the first image from your input data. Then right click on “labels” and click on import. Navigate to your annotations folder >> Mask >> and select the annotated image with identical name as selected in the current view. Click OK in the pop-up window. The manual annotations (generated in step 49) of this image will now appear on the screen.\nNote: Step 51f only works if users have generated annotations of all categories in all images. Otherwise, annotations will be put in the wrong category.\nRepeat step 51f for every image present in the project.\nClick live update (This takes ∼5 min for 10 training images. This step takes longer depending on the number of images and annotations included in the project).\nClosely investigate the prediction maps. You can do this by scrolling down in the left window and selectively visualizing the prediction for label 1, 2, and 3 by clicking on the eye. Confirm that nuclei and background are properly identified (i.e., nuclear borders are properly defined, nuclei are not merged, and nuclei are not split into multiple events). In case nuclei and background are not properly identified, add additional annotations to the training set by repeating steps 49–51.\nTurn off live update.\nGeneration of DAPI probability maps of validation data:\nIn the Prediction Export tab, select Probabilities in the Source drop down menu. Then click on the ‘Choose Export Image Settings…’ button.\nChange export format to multipage tiff.\nChange “Convert to Data Type” to unsigned 32-bit.\nIn the output file info box, specify the saving directory and add a naming pattern.\nClick on OK.",
    "Critical: In order to use the CellProfiler pipeline for cell segmentation during downstream analysis, make sure that the names of the exported DAPI probability maps (step 52 + 53) and IMC probability maps (step 55 + 56) are identical.\nIn the Batch Processing tab, click on ‘Select Raw Data Files...’. Select the images within the Morph-Feat folder of the validation data. Then click on “Process all files”.\nClosely investigate the probability maps and confirm that nuclei and background are properly identified. Troubleshooting 3[href=https://www.wicell.org#troubleshooting]\nGeneration of DAPI probability maps of full dataset:\nIf nuclei and background are properly identified, proceed with generating DAPI probability maps of the full dataset by repeating step 52a and 52b. Select the images within the Morph-Feat folder of the Stitch folder. Specify the saving directory and naming pattern.\nIMC probability maps\nTiming: 8 h\nIn this step, IMC probability maps for cell membranes and nuclei are generated based on the IMC images in Ilastik software. Generating IMC probability maps for 10 158 × 158 μm training images takes approximately 8 h.\nGenerate IMC probability maps:\nStart the Ilastik software and select the pixel classification workflow.\nIn the Input Data tab, add the images in the IMC MachineLearning training folder to the project.\nSelect all the added files and right click. Click on “Edit shared properties” and change storage from “relative link” to “copy into project file”. Click on OK.\nIn the Feature Selection tab, click on “Select Features”. Select all features with omega 0.3 to 1.6 and click on OK.\nProceed to the Training tab and add the labels you would like to train for. For instance: (1) background, (2) immune cell membrane, (3) immune cell nucleus.\nNote: Write down the included labels and their names in their respective order! You need this for further steps.",
    "Note: It is recommended that different people annotate images for training in order to obtain reliable segmentation data.\nIn the current view box, select an image of interest. In the left window, go to “Raw Input” and browse through the different IMC channels of this image using the number indicated in the box. Each number corresponds to an IMC channel included in the machine learning image stack, starting at 0. In the example presented in Figure 12[href=https://www.wicell.org#fig12], Iridium (nuclei), CD45, CD3, and CD8 were chosen for training.\nimgsrc:https://prod-shared-star-protocols.s3.amazonaws.com/protocols/1297-Fig12.jpg\nFigure 12. IMC annotations and probability maps\nIMC images are used for machine learning to create membrane and nucleus probability maps.\n(A) different channels are used for annotating membranes (red) and nuclei (blue). Scale bars indicate 10 μm (top rows), 25 μm (bottom row).\n(B) Exported probability maps of the example shown in (A). Scale bar indicates 25 μm.\nIdentify a cell with a clear membrane signal (example in Figure 12[href=https://www.wicell.org#fig12]). Then scroll through the different channels and make sure a nucleus is present for the chosen cell.\nStart making pixel annotations of membranes and nuclei. A few things to keep in mind:\nUse multiple channels to annotate the membrane of a cell. For instance, start making membrane annotations based on the CD45 signal. When finished, scroll through the IMC channels to see whether this cell is also CD3+ or CD8+. If there are white/light grey pixels in these channels that are not annotated yet, but belong to this specific cell, add pixel annotations based on this signal.\nOnly annotate pixels that give a clear signal. Hence, annotate white and light grey pixels, but not black pixels! This means that sometimes, membrane annotations do not completely surround the nucleus annotation (Figure 12[href=https://www.wicell.org#fig12]).",
    "You can annotate membranes of a cell without annotating the nucleus.\nIt is possible to annotate multiple cell types based on different markers.\nTurn on live update and closely investigate probabilities. You can do this by scrolling down in the left window and visualizing the prediction for the different labels by clicking on the eye. Confirm that all classes are properly identified. Troubleshooting 4[href=https://www.wicell.org#troubleshooting]\nTurn off live update.\nGeneration of IMC probability maps of the validation data:\nIn the Batch Processing tab, add the images in the IMC MachineLearning validation folder to the project.\nExport the probability maps as described in step 52.\nGeneration of IMC probability maps of the full dataset:\nIf nuclei, membranes, and background are properly identified (Figure 12[href=https://www.wicell.org#fig12]B), proceed with generating IMC probability maps of the full dataset by repeating step 52a and b. Select the images within the MachineLearning folder. The prediction export of 10 images takes approximately 15 min.\nSingle-cell segmentation\nTiming: ∼1 day\nIn this step, single-cell segmentation is performed in CellProfiler software using the DAPI and IMC probability maps generated with Ilastik.\nStart the CellProfiler software and import the CP-Pipeline.cppipe via file > import > Pipeline from file. The CellProfiler panel is divided into three sections as shown in Figure 13[href=https://www.wicell.org#fig13].\nimgsrc:https://prod-shared-star-protocols.s3.amazonaws.com/protocols/1297-Fig13.jpg\nFigure 13. Screenshots CellProfiler interface\nThe CellProfiler pipeline panel is divided into three sections: the \"Modules Image Input\" in which to specify information about the images to be processed, the \"Modules Analysis\" which are executed sequentially to process the images, collect the measurements, and write the output. The \"Module Settings Panel\" provides the customizable settings for each selected module in the Pipeline panel.\nConfiguring image input for CellProfiler:",
    "Select the Images module. A box will appear in the module settings panel prompting for files to be placed into the box. Drag-and-drop the folders containing IMC probability maps and DAPI probability maps.\nConfigure metadata:\nSelect the Metadata module and click on “yes” to “Extract metadata?”.\nIn the drop-down menu “Metadata extraction method”, select “Extract from image file headers”.\nChange “Extract metadata from” to “Images matching a rule”.\nSelect the rule criteria which looks like “File”, “Does”, “Contain”, and write the name “IMC” in the empty box. Click “+” to add another rule and write “DAPI” in the empty box.\nClick on the “update metadata” button below the horizontal divider.\nConfigure naming patterns:\nSelect the NamesAndTypes module. All image types to be used by CellProfiler have to be identified based on their filename.\nAssign a name to “image matching rules”.\nSelect the rule criteria “File”, “Does”, “End with”. Define criteria that are specifically true for all IMC and DAPI probability map tiff files and write the name in the box “Probability”. You can add extra rules and name of the images by clicking “+”.\nIMC prob → “IMC_prob_membrane”, “IMC_prob_nucleus”.\nFLUOR prob → “FLUOR_prob_membrane”, “FLUOR_prob_nucleus”\nName to assign these images: Enter a suitable descriptive name to identify the image for later use in the pipeline; downstream modules will then refer to the image by this name for processing. For example, “IMC_prob_membrane” can be used to indicate that all images associated with this type represent the membrane channel from the probability maps generated with the IMC data.\nPress the “Update” button below the horizontal divider to index and display a table containing all identified images. Each row displays an unique image set, and the image types are listed in columns.",
    "Critical: This module is critical, when applying to your data carefully read the online CellProfiler manual for this module: https://cellprofiler-manual.s3.amazonaws.com/CellProfiler-4.0.5/modules/input.html#namesandtypes[href=https://cellprofiler-manual.s3.amazonaws.com/CellProfiler-4.0.5/modules/input.html].\nSelect the module “IdentifyingPrimaryObject”. This will be used to identify nuclei within the DAPI probability maps nuclear category.\nOptional: We have used the Otsu method for threshold strategy which automatically finds thresholds by dividing image pixels into two categories (foreground and background) by minimizing the variance within each class. The threshold method and value can be changed if required. Troubleshooting 5[href=https://www.wicell.org#troubleshooting]\nNote: By selecting “intensity” in this module in the CellProfiler pipeline as the de-clumping method, a line will be drawn between the areas of two nuclei whose boundaries intercept. These nuclei will then be separated and identified as distinct nuclei.\nChoose ‘IdentifyingSecondaryObject’. This module will propagate outwards from the identified nuclei to create new objects that cover both the nuclei and edges. IdentifySecondaryObject modules require a FLUOR image plus nuclear primary objects which have already been identified.\nNote: At this stage the pipeline has identified all nuclei in the probability maps and translated that information into a segmentation map that represents all identified nuclei as illustrated in Figure 14[href=https://www.wicell.org#fig14], and Figure 15[href=https://www.wicell.org#fig15].\nimgsrc:https://prod-shared-star-protocols.s3.amazonaws.com/protocols/1297-Fig14.jpg\nFigure 14. Identification of primary and secondary objects\n(A and B) (A) Identification of primary object and (B) Identification of secondary objects of a particular tissue region in CellProfiler. Image axes are pixels. Image resolution is 0.65 μm/pixel.\nimgsrc:https://prod-shared-star-protocols.s3.amazonaws.com/protocols/1297-Fig15.jpg\nFigure 15. Single-cell segmentation map\nDisplay of regions of interest (ROI) showing an overlay of DAPI (white), and the predicted cell outlines for nuclear segmentation (magenta). Scale bar indicates 200 μm (left) and 25 μm (right).",
    "This pipeline will save the segmentation maps and filenames in the “object folder” (folder naming specified by the user in the CellProfiler pipeline) based on IMC input names with suffixes for e.g., IMC_primary_object or IMC_secondary_object.\nRun the pipeline in test mode by pressing the button “Start test Mode” to check whether each module is working correctly. Repeat this on another image set to make sure set parameters are adequate.\nStart the analysis by pressing the “Analyze Images” button. The output from the CellProfiler pipeline is a comma-separated value (.csv) file summarizing the key values extracted during the image-processing step along with the images.\nSingle-cell data generation\nTiming: ∼40 min\nSingle-cell data is generated by extracting pixel intensities from unscaled 32-bit images for all channels for all cells represented in the segmentation maps.\nMATISSE single-sell data generation:\nOpen script ExtractSingleCellDataParallel.r in RStudio.\nInput the paths of the folder “Object” where all image files are stored.\nMake sure all input images can be recognized using the associated filename patterns mentioned in step 63.\nAfter completion of the script, single-cell data is stored in the file \"SingleCellData-MATISSE.Rda\".\nCritical: Before running the script in step 66a, locate the path of the segmentation maps based on their location in the drive."
  ],
  "subjectAreas": [
    "Bioinformatics",
    "Antibody",
    "Biotechnology And Bioengineering",
    "Microscopy",
    "Cell Biology",
    "Mass Cytometry",
    "Single Cell"
  ],
  "bigAreas": [
    "Molecular Biology & Genetics",
    "Bioinformatics & Computational Biology",
    "Bioengineering & Technology"
  ]
}