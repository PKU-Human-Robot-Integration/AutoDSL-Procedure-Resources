{
  "id": 11762,
  "origin_website": "Jove",
  "title": "Multiplex Immunohistochemical Analysis of the Spatial Immune Cell Landscape of the Tumor Microenvironment",
  "procedures": [
    "Patient material that is shown for this protocol was part of a previously conducted study and was officially deemed exempt from medical ethical approval by the local Radboudumc Medical Ethical Committee concurrent with Dutch legislation (file number 2017-3164)30.\n1. Collection of FFPE material, selection of blocks, and preparation of samples\nRetrieve FFPE block identifiers from patient files through treating physicians or pathologists. Check with local regulations whether ethical permission is required.\nRequest FFPE blocks from the local pathology archive or external hospital(s).\n\tNOTE: It is also possible that tumor material or a biopsy is acquired for a particular study. This can be the case for small clinical trials or animal studies. In these cases, processing of the tissue sample may be the responsibility of the researcher.\nWhen multiple FFPE blocks are available, select the most representative FFPE block containing viable tumor tissue, preferentially with surrounding stromal tissue present by assessing the hematoxylin and eosin (HE)-stained slides (Figure 1).\n\tNOTE: It is advised to obtain an expert opinion for this selection (e.g., a pathologist). It is possible that HEs are unavailable for assessment of the content of an FFPE block and new ones need to be made for the selection. Go to section 2 for a description.\nCut FFPE ribbons of 4 µm thickness on a microtome.\n\tNOTE: The thickness can be between 1 µm and 6 µm without noticeable staining impact; however, 4 µm is the most standard.\nMount the samples on glass slides at a position that is favorable for the fluidics of the autostainer (Figure 2A-C) using one of the methods described below:\n\t\nPlace the sections on the surface of distilled 40 °C water in a water bath to stretch out and pick them up with a glass slide.\n\t\tOR",
    "Place glass slides on a 40 °C heating plate, making sure to cover the spot where the section is to be mounted on the slide with a drop of distilled water. Place the section on top of this drop with forceps and allow it to stretch out. Absorb distilled water using a paper towel and remove excess water by tapping the slide.\n\t\tNOTE: Placing tissue sections too close to the label of the slide will result in suboptimal staining (Figure 2D,E). We tend to mount 6-10 glass slides per sample to perform the different multiplex IHC panels and to have a backup.\nLet the mounted glass slides dry at 56 °C for 1 h or overnight at 37 °C.\nUse the mounted glass slides for the experiment or store these in boxes at 4 °C.\n\t​NOTE: In our experience so far, these mounted slides can be stored for years before multiplex IHC staining is carried out.\n2. Generating hematoxylin and eosin-stained slides\nNOTE: All following steps of section 2 are to be carried out in a fume hood.\nDeparaffinize slides in xylene (2 x 5 min).\nRehydrate in ethanol (99.6% 1 x 5 min; 95% 1 x 5 min; 70% 1 x 2 min). Alternatively, dip the slides 3x in 99.6% ethanol.\nWash the slides in distilled water (2 min).\nStain the nuclei with hematoxylin (10 min).\nWash the slides with distilled H2O (5 min).\nStain the slides with eosin (5 min).\nDehydrate the slides by dipping 3x in 99.6% ethanol.\nDip the slides 2x in xylene.\nAdd a few drops of mounting medium and seal with a coverslip.\nLet the slides harden and take the slides out of the fume hood when all the chemicals have evaporated.\n3. Performing monoplex and multiplex IHC in the autostainer",
    "Calculate how much reagent is needed depending on the number of samples to be stained.\n\tNOTE: Per run, the autostainer has a capacity of 30 slides and takes ~18 h to complete the multiplex IHC protocol with six antibodies. When more slides need to be stained, multiple batches can be put in every night of the (work)week; 4 nights of 30 slides = 120 slides per week.\n\t\nPrepare all necessary reagents at the start of the week. The autostainer system dispenses 150 µL of reagent per slide. Use the 6 mL titration containers for antibody and Opal reagents and the 30 mL containers for the blocking reagent and the secondary antibody-horseradish peroxidase.\n\t\tNOTE: The 6 mL containers have convenient inserts that can easily be taken out and replaced when necessary. With reagent calculations, one has to consider the dead volume of 1.6 mL or 300 µL for the 30 mL container or 6 mL titration container, respectively.\nDilute all Opal fluorophores and digoxigenin (DIG) 1:100 in the provided diluent; dilute Opal780 1:25 in the antibody diluent. Dilute all the primary antibodies in antibody diluent, with dilutions specified in Supplemental File 1.\nTo follow this protocol, run monoplex IHC (Supplemental File 2) on slides containing both tonsil control tissue and other (tumor) tissue types of interest before starting with the actual multiplex IHC experiment to make sure all reagents are prepared well.\n\tNOTE: Monoplex IHC takes ~3.5 h and can be checked before the end of that day for signal patterns and intensity. If certain signals are too weak (Figure 3), adjustments to reagents can be made.",
    "For autofluorescence correction, prepare a slide with (tumor) tissue containing autofluorescent structures, such as blood and collagen. Prepare this slide simultaneously with monoplex IHC slides, but with blocking reagent replacing the antibody and Opal reagents (Supplemental File 3).\n\tNOTE: In principle, such a slide can be reused for multispectral imaging until autofluorescence correction is not optimal anymore. However, with highly autofluorescent tissues, such as the brain and liver, it is advisable to use that tissue for the autofluorescence correction.\nWith each multiplex IHC run, load 29 samples into the autostainer system with one control tissue slide to check the performance of each multiplex IHC run.\nDownload multiplex IHC protocols from the website of the autostainer under the Downloads tab and adjust them to fit each customized multiplex IHC panel36. For multiplex IHC, see Supplemental File 4 for the protocol and for customized multiplex IHC panels, see Supplemental File 1.\nAfter completion of the staining protocol, take the slides out of the autostainer and put them in a container with wash buffer.\nTo prevent contamination of the autostainer system with DAPI as samples are already stained at very low concentrations, apply DAPI manually before covering the slides with coverslips. Add two drops of DAPI per mL of wash buffer and incubate for 5 min at room temperature in the dark.\n\tNOTE: For building spectral libraries, it is important to not have any DAPI stained in the samples. One drop of DAPI per mL of wash buffer and 10 min of incubation at RT is also possible.\nWash the slides 3x with wash buffer.\nPlace the slides on paper towels and tap the excess wash buffer off the slides.\nPipet a few drops of mounting medium on the tissue.",
    "Place a glass coverslip gently on top of the mounting medium to cover the slide at an angle to avoid air bubbles.\nRemove excess mounting medium and air bubbles by gently pushing on the glass coverslip with forceps or a clean pipet tip.\nLeave the slides undisturbed for ~24 h before the mounting medium solidifies, either horizontally on a microscopy slide board or load them directly into the microscope for imaging.\nAfter the mounting medium is solidified or after the slides are imaged, store the slides in microscopy boxes at 4 °C.\n4. Imaging using the digital pathology imager and annotation of scan files\nTurn on the imager by pushing the power button on the right of the machine. After at least 20 s, start up the software.\n\tNOTE: Wait for 20 s to allow the hardware to start up correctly.\nLoad the slides into the cassettes per four slides.\n\t\nOptional: Enter the slides into a .csv file for which a template can be downloaded (Supplemental File 5). To load the .csv file into the program, save it at C:\\Users\\Public\\Akoya\\VectraPolaris\\States.\n\t\tNOTE: A maximum of 20 cassettes or 80 slides can be loaded simultaneously.\nReference settings\n\t\nOpen Check Dashboard from the main menu.\n\t\tNOTE: A cassette with reference slides is provided by the manufacturer and can optionally be kept permanently in slot 20.\nSet the brightfield references on the provided slide once per week according to the manufacturer's instructions (takes a few minutes).\nSet the fluorescence references on the provided slide once per month according to the manufacturer's instructions (takes more than 1 h).\nMaking or adjusting the protocol\n\t\nGo back to the main menu and click Edit Protocol to make a protocol.",
    "Click New… and select Fluorescence as Imaging Mode, Multispectral Slide Scan, and Opal Polaris 5, 6, and 7 color under the Staining option.\nGive the protocol a name under Protocol Name and save it under a study by selecting a study from Available Studies or create a study under Create New Study | Study Name.\nFinish by selecting Create Protocol.\nFor this type of scanning, use only the left window Multispectral Slide Scan Settings; ignore the window on the right Multispectral Field Settings.\nScan the slides at different magnifications. To follow this protocol, scan at 20x magnification by leaving the Pixel Resolution at 0.50 µm (20x).\nSet the exposure times by selecting Scan Exposures.\nLoad the cassette in which the slides are kept by selecting the correct slot under the Load Carrier option.\nTo help navigate through the slides, select Take Overview to acquire an overview image of the carrier containing the slides after the carrier is loaded. To turn this on or off automatically, click the gear icon on the top right, go to Preferences…, and tick the option on or off under Navigation Overview Image to enable Automatically image carrier when loading for interactive tasks.\nSet exposure times per filter on the corresponding monoplex IHC stained slides by selecting Set Scan Exposures and finding different spots with a positive signal. Manually focus or use Auto Focus and select Autoexpose after switching to the compatible filter for that signal. Select the lowest exposure time to prevent overexposure and take snapshots of each slide for reference after all exposure times are set (Figure 3).\n\t\tNOTE: Ignore the Set Field Exposures option for this type of scanning.",
    "Set the exposure times on a multiplex stained slide by checking all the filters on a few locations with positive signal. Reduce the lowest autoexposure time by 10% to prevent overexposure and take a few snapshots after all exposure times are set.\nTake snapshots of the unstained slide for autofluorescence compensation by using the Sample AF filter to navigate (Figure 3H).\n\t\tNOTE: Locations with erythrocytes and collagen structures are of interest. The exposure time of the Opal480 filter may need to be reduced for strong autofluorescent regions. If the Opal480 signal is strong enough, it should still be separated well (see section 6) from the autofluorescent structures because of the implementation of the proprietary Sample AF filter.\nAssess the quality of the staining and imaging using the software (see sections 5 and 6; Figure 4, Supplemental File 6: Supplemental Figure S1, and Supplemental Figure S2).\nSelect the Save… button to make sure that the protocol and its adjusted exposure times are saved into the protocol.\n\t\tNOTE: When the protocol is already saved, no extra notification of unsaved adjustments is given by the software so far.\nAutomatic scanning of slides\n\t\nGo back to the main menu and click Scan Slides to scan the slides.\nManually enter slide names/IDs and corresponding tasks and protocol under Configure Tasks or automatically from the previously made .csv file with Load Setup.\nClick Scan to start the scanning.\nWait for a window to pop up to save the scan setup. Click Save to use the default settings and start scanning.\n\t\tNOTE: Scanning using this method takes ~10-20 min per slide. Depending on the number of slides, scanning can take up to a full day.",
    "Check whether the scanning of the slides was successful for all slides by looking for any error messages. To know if scanning is successful, look for a saved Akoya whole slide scan file (.qptiff) of the scan and the complete tissue in the scan.\n5. Annotation of data using the slide viewer\nGo back to the main menu and click Launch Phenochart to open the slide viewer.\nIf the scan files are not directly visible, appoint their location by first clicking on the gear icon in the upper right corner, go to Change Browser Location… and randomly select one of the .qptiff files of the dataset of interest.\n\tNOTE: Data are by default stored at D:\\Data\\VectraPolaris.\nLoad a slide by selecting it and clicking Load in the upper right corner or by double-clicking on it.\nLogin by clicking on the Login button in the upper right corner.\n\tNOTE: The username can be just the initials or name and is used to keep track of who made which annotations.\nTo perform unmixing, click on the Unmixing button on the top and select the Opal + AF option.\n\tNOTE: This is useful to get rid of some of the autofluorescent signal near the Opal 480 channel, but not all.\nTo generate an algorithm for batch-processing the data, select representative images using the Stamp using the for inForm Projects 1 x 1 images (image size: 928 µm x 696 µm) option.\n\tNOTE: A few representative stamps containing tumor, stroma, background, and different types of immune cells are selected throughout the dataset to end up with ~20-30 images.",
    "Depending on what needs to be analyzed in the tissue, select a region of interest using the ROI option and select for inForm Batch. Manually delete images that do not need to be analyzed, such as images that are too far away from the tumor or in the background.\n\tNOTE: We tend to draw an ROI around the whole tumor and select one extra image away from the tumor region to be able to analyze an IM of ~0.5 mm.\n\tIf the drawn ROI is relatively small, the ROI will consist of 2-9 merged 20x images. As this is not preferred by us, manually stamp the tissue of interest (selected for inForm Batch) to circumvent this.\nWhen finished annotating, let the annotations be automatically saved and load the next slide.\nDuring the annotation process, check if the slides are correctly scanned.\n\t\nIf a .qptiff file is missing or a slide is not successfully scanned, check if any tissue is present on the slide, clean the slide with 70% ethanol, and scan again.\nIf the tissue is not fully scanned, thereby missing a potentially important (tumor) region, or if the scanning of the important region was out of focus, clean the slide with 70% ethanol and scan again.\n\t\tNOTE: In both cases, it can also help to encircle the tissue with a marker on top of the coverslip to help the system to locate the tissue and try scanning again (Supplemental File 6: Supplemental Figure S3). In our hands, a thin red marker worked better than a thick black marker.\nOnce scanning and annotation of all samples are completed, back up the data by storing them on a different computer or external disk.\n6. Spectral unmixing\nOpen the inForm Automated Image Analysis Software.",
    "Load the images into the software by File | Open Image; select .qptiff files. Let the stamps, marked as inForm Projects in step 5.6, be loaded into the project.\nLoad the .qptiff files that are imaged for the autofluorescence compensation.\nTo compensate for autofluorescence, use the select autofluorescence on the image tool to draw a line on the image from the unstained slide through different types of structures that are autofluorescent, such as erythrocytes and collagen.\nIn the Edit Markers and Colors… section, assign marker names that correspond to the Opal fluorophore and adjust the color to the preferred one.\nTo unmix the fluorophores, select Prepare All in the lower left corner.\nGo through the images and check if all signals are visible in the images and if the unmixing went well. Select the eyeball icon to turn off and on all the markers one by one to check the quality.\nOptionally, train the algorithms for tissue segmentation, cell segmentation, and phenotyping.\nGo to the Export tab and make a new empty export directory by clicking the Browse… button under the Export Directory.\nUnder the Images to export:, select Composite Image and Component Images (multi-image TIFF).\nSelect File | Save | Project to save the algorithm at a certain location.\nGo to Batch Analysis tab vertically on the left for the batch processing of slides.\nSelect Create separate directories for each item under the Export Options.\nTo add slides for analysis, select .qptiff files under the Add Slides… button and load them into the batch analysis.\nSelect Run to start the batch processing of slides.\n7. ROI drawing\nCreate a folder with only the component files from section 6, but keep the hierarchical folder structure intact (component files being in folders named by sample/slide).",
    "Open the QuPath whole slide viewer software.\nClick Create project on the left and select/make a new empty folder with a suitable name.\nClick Automate and select Show script editor.\nCopy-paste the script that is available in Supplemental File 7. At line 34, change the location to where the slide folders containing all the component files are (the folder created in step 7.1.\nSelect Run and return when the batch stitching of slides is finished (the next day or later) to continue.\nDrag the generated .ome.tif files into the QuPath project and save them as a project.\nWhen a new window automatically pops up, select Set image type | Fluorescence and click Import.\nIn the menu to the left, observe the list of samples; double-click on one to open the sample (Figure 5A).\nTo adjust the intensity of the channels to make them better visible, click the contrast icon.\nSelect all channels and click Reset.\nToggle off autofluorescence.\nTo start drawing an ROI for the tumor, click the contrast icon and select Show grayscale. Select the tumor marker channel and adjust the intensity to make it optimally visible (Figure 5B).\nClick the brush tool to draw a tumor ROI roughly.\nWhile selecting the wand tool, click outside the ROI while pressing the alt key to smooth the ROI from the outside (Figure 5C).\nMerge separated tumor pieces with the same ROI.\nGive the ROI a suitable name such as tumor by right-clicking the annotation in the list on the left; select Set properties and enter the name.\nTo make an ROI for the IM, expand the existing ROI from the tumor region by selecting: Objects | Annotations… | Expand annotations.\nSelect what size the expansion radius should be and select Remove interior and Constrain to parent (Figure 5D).",
    "Click the contrast icon, select the autofluorescence channel, and adjust the intensity to make it optimally visible.\nClick the wand and adjust the ROI while pressing the alt key to smooth the ROI from the outside and remove any background that should not be part of this ROI.\nGive the ROI a suitable name such as invasive margin or IM by right-clicking the annotation in the list on the left, select Set properties, enter the name, and optionally change its color to green.\nSave the annotations: File | Export objects | Export All objects and click OK with the default selection on Export as FeatureCollection and save it at a preferred location.\n8. Immune cell detection\nAs ImmuNet uses component data (multi-channel TIFF files) for both training and inference, split annotations into training and validation sets. To train the model, follow the steps described in the Readme file of the repository, substituting the example dataset and annotations with the desired data. Apart from different immune cells, provide the model with negative examples by making background annotations at sites that should not be recognized as a cell of interest: tumor cells, other cells, or \"no cells\" (structures that could be confused with cells of interest); see the ImmuNet publication for details32.\nUsing the validation annotations, ensure that the performance is satisfactory. Look at the error rate per annotation type - a share of validation annotations that the model has not detected - the most straightforward evaluation metric. Evaluate the performance with respect to false positives by making a few fully annotated ROIs and calculating the F-scores.",
    "In addition to quantitative evaluation, visually inspect the prediction to get a qualitative sense of the errors the model tends to make (Figure 6, Supplemental File 6: Supplemental Figure S4, and Supplemental Figure S5). If the model performance is judged to be insufficient, visualize the prediction for some tiles as described in the repository and check which sites are the most error-prone. Make more annotations at such sites and re-run model training and evaluation.\nWhen the target performance is achieved, run the inference for the whole dataset as described in the Inference for the whole dataset section of the repository Readme. Use the obtained .csv files with the model prediction as input for data analysis (write a Python or R script for that).\n9. Prediction phenotyping and data analysis\nNOTE: In this section, we give an example of simple data analysis for a single melanoma sample stained with the lymphocyte panel, which combines the locations of immune cells identified by ImmuNet (section 8) and ROIs delineated with QuPath (section 7). The analysis has been performed in R 4.1.1 (a script is provided as Supplemental File 8). The script requires the packages: plyr 1.8.8, dplyr 1.0.8, tidyr 1.2.0, sf 1.0-7, ggplot2 3.4.0, RANN 2.6.1, and RColorBrewer 1.1-2, which can be installed with the install.packages() command. As an input, it takes a .csv file with ImmuNet's prediction of a sample and a file with ROIs exported from QuPath. Steps 9.1-9.6 describe the analysis of a single sample performed in the provided script, and sections 9.7-9.9 describe options for the analysis of multiple samples.\nAfter loading ImmuNet's prediction into R, determine the thresholds for predicted marker expression by plotting the markers that define phenotypes against each other and selecting the thresholds that separate the populations best.",
    "NOTE: The gating strategy used for the given sample is shown in Figure 7B. Gating strategies for the myeloid and dendritic cell panels are shown in Supplemental File 6: Supplemental Figure S6 and Supplemental Figure S7.\nAfter determining the thresholds, use them to assign each ImmuNet prediction a phenotype defined in a panel. In some predictions, observe that neither of the predicted markers is above the threshold or the combination of markers considered expressed after thresholding may be inconsistent (e.g., CD3+ CD20+ predictions in the lymphocyte panels). If good model performance is achieved at step 8.3, the fraction of such predictions will be small; filter them out before the analysis.\nTo separately analyze ROIs for the tumor and its invasive margin up to 100 µm drawn in QuPath, load the corresponding GeoJSON files in R, and for each prediction, determine the ROI into which the prediction falls.\nFor a sanity check and as a part of the exploratory data analysis, visualize the immune cells found in a sample separately in the corresponding ROIs together with ROIs' boundaries (Figure 7A).\nNow, calculate the densities of different immune cells separately for each ROI. The densities found in the given sample are shown in Table 1.\nIf multiple samples are available, visualize the distribution of cell densities. Log-transform the density values to achieve normally distributed values.\n\tNOTE: When counts of certain phenotypes are 0, these cannot be Log-transformed, leading to missing values. To overcome this problem, LaPlacian smoothing can be applied by adding 0.5 to all cell counts first before dividing by the surface area.\nAnalyze the density values and plot them using the software of choice (Figure 8).",
    "Preserved locations of cells enable spatial analysis. For instance, for each detected immune cell, find a nearest neighbor, and then for each phenotype, calculate the percentage of cases when the different phenotypes occur as the nearest neighbor.\n\tNOTE: Since the number of natural killer (NK) cells found in this sample was very small, we excluded them from this analysis. The obtained results for Tumor and IM ROIs are given in Figure 9."
  ],
  "subjectAreas": [
    "Cancer Research"
  ],
  "bigAreas": [
    "Biomedical & Clinical Research"
  ]
}